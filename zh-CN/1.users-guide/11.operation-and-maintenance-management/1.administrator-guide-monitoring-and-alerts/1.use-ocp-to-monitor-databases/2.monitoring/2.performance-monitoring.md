# 性能监控

可以在 OCP 上查看集群的历史性能监控信息。

## 所有集群的性能监控

1. 登录 OCP。

2. 在左侧导航栏单击 **集群** ，进入 **集群** 页面。

   在 OCP 的 **集群** 页面展示了当前所有集群的性能指标 Top5 信息。您可以查看某个时间段某个性能指标的和从大到小排序最大的 5 个集群。

   可以根据业务需要，选择待查看的性能指标和对应的时间范围。单击右上角图标，可对图标进行放大查看。

   ![1](http://icms-x-dita.oss-cn-zhangjiakou.aliyuncs.com/xdita-output/zh-CN/task18756973/images/p264657.png?Expires=7258130666&OSSAccessKeyId=LTAIJfoPL6wmrirR&Signature=qh%2BPuuyadL7yessEV%2FlNwY3WJuE%3D#crop=0&crop=0&crop=1&crop=1&id=DP9Gm&originHeight=272&originWidth=1336&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=)

   可选择的时间范围包括： **最近一小时** 、 **最近一天** 和 **最近一周** 。

   可选择的性能指标包括： **QPS** 、 **查询响应时间** 、 **活跃会话数** 和 **CPU 使用率** 。各指标的含义如下表所示：

   |    性能指标     |                  含义                  |
   |-------------|--------------------------------------|
   | QPS（time/s） | Query Per Second，当前 OCP 管理的集群的每秒查询率。 |
   | 查询响应时间（us）  | 显示集群的平均查询响应时间。                       |
   | 活跃会话数       | 显示单位时间内的活跃会话总数。                      |
   | CPU 使用率（%）  | 显示集群内 CPU 使用率的平均值。                   |

   > **说明**
   >
   > 当某个集群中的某个性能指标值激增，可在该集群中的 **性能监控** 页面，通过关联关系找到指标值激增的租户，进一步确定指标值激增的主机。详细信息请参见下文中的 **指定集群的性能监控** 。

## 所有租户的性能监控

1. 登录 OCP。

2. 在左侧导航栏上，单击 **租户** ，进入 **租户** 页面。

   在 **租户** 页面的 **租户监控 TOP5** 区域，可以查看当前所有集群中工作负载最高的 5 个租户的性能信息，包含 **TPS** 、 **QPS** 、 **SQL 响应时间** 、 **事务响应时间** 、 **活跃会话数** 、 **事件等待_次数** 、 **事件等待_时间** 、 **容量_表数量** 、 **容量_分区数量** 等性能监控指标。

   可以查看最近一小时、最近一天或最近一周的监控信息。

   ![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer/V3.1.3/zh-CN/operation-and-maintenance-management/administrator-guide-monitoring-and-alerts/use-ocp-to-monitor-databases/2.%E6%89%80%E6%9C%89%E7%A7%9F%E6%88%B7%E7%9A%84%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7.png)

   性能监控指标相关说明如下表所示：

   |   指标名    |            说明            |            数据来源             |
   |----------|--------------------------|-----------------------------|
   | QPS      | 平均每秒处理的 SQL 语句的次数 (次/s)  | `v$sysstat`                 |
   | TPS      | 平均每秒处理事务的次数 (次/s)        | `v$sysstat`                 |
   | SQL 响应时间 | 服务端每条 SQL 语句的平均处理耗时 (us) | `v$sysstat`                 |
   | 事务响应时间   | 服务端每个事务平均处理耗时 (us)       | `v$sysstat`                 |
   | 活跃会话数    | 当前活跃会话数 (个)              | `__all_virtual_processlist` |
   | 事件等待_次数  | 每秒等待事件的次数 (次/s)          | `v$system_event`            |
   | 事件等待_时间  | 每个等待事件的平均耗时 (us)         | `v$system_event`            |
   | 容量_表数量   | 表数量（个）                   | `gv$table`                  |
   | 容量_分区数量  | 分区数量（个）                  | `v$partition`               |

   > **说明**
   >
   > 当某个租户的某个性能指标值激增，可在该租户中的 **性能监控** 页面，通过关联关系找到指标值激增的主机。详细信息请参见下文中的 **指定租户的性能监控** 。

## 指定集群的性能监控

1. 登录 OCP。

2. 在 **集群** 页面的 **集群列表** 区域，选择待操作的集群并单击其集群名。

3. 在显示的页面的左侧导航栏上，单击 **性能监控** 。

4. 在 **数据筛选** 区域，根据多种维度对租户的性能信息进行筛选。

   关闭 **实时** ：输入过滤条件后，系统按 **选择的时间** 及 **统计周期** 展示性能监控数据。

   打开 **实时** ：选择统计范围，系统实时展示该统计范围内的性能监控数据。

   筛选条件说明如下表所示：

   |     筛选条件      |                                                                                   **描述**                                                                                   |
   |---------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
   | 选择时间（又称：监控窗口） | 实时模式下不展示。 选择某一段时间范围，用于返回这段时间范围内的数据。                                                                                                                        |
   | 统计周期          | 实时模式下不展示。 主要用于计算每个点数据的统计周期，支持按 **每分钟** 和 **每秒** 统计，分别对应了每分钟一个点或每秒钟一个点，OCP 同时也会根据选择的时间区间再去计算一个统计周期，计算的规则是使返回的数据接近 1440 个点，如果选择的时间区间比较长，可能会出现统计周期大于 1 分钟的情况。 |
   | 统计范围          | 指定统计范围为某个 Zone 或某一 Zone 下的某一 OBServer。 默认统计所有 Zone 的监控数据。                                                                                                  |

   ![1](http://icms-x-dita.oss-cn-zhangjiakou.aliyuncs.com/xdita-output/zh-CN/task18756973/images/p167601.png?Expires=7258130666&OSSAccessKeyId=LTAIJfoPL6wmrirR&Signature=mRm5dEE%2FAhNr0pldFHOwERLr1i0%3D#crop=0&crop=0&crop=1&crop=1&id=dw68z&originHeight=371&originWidth=646&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=)

5. 切换页签，分别查看集群的 **数据库性能** 和 **主机性能** 数据。

   * **数据库性能** 页签。

     如果需要展示其他指标，您可以单击区域右侧的 **指标选择** 按钮，在 **指标选择** 面板中选择需要展示的指标，系统最多支持展示 10 个指标。

   * **主机性能** 页签。

     统计范围包含多台 OBServer 时，则展示多台 OBServer 的聚合值。

     如果需要展示其他指标，您可以单击区域右侧的 **指标选择** 按钮，在指标选择页面选择需要展示的指标，系统最多支持展示 10 个指标。

   **数据库性能** 和 **主机性能** 中具体指标的含义请参考对应版本的 《OCP 用户指南》 文档的 **监控指标** 附录的内容。

   下述功能能够帮您更好的在趋势图中查看和分析性能监控数据，您可结合图片及下述文字理解。

   ![1](http://icms-x-dita.oss-cn-zhangjiakou.aliyuncs.com/xdita-output/zh-CN/task18756973/images/p443870.png?Expires=7258130666&OSSAccessKeyId=LTAIJfoPL6wmrirR&Signature=cv5URJ7onTj1gnT3qpuJbjBYYrg%3D#crop=0&crop=0&crop=1&crop=1&id=xRFsd&originHeight=316&originWidth=769&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=)

   * 筛选数据。

     * 查看某一指标的在某一时间段的详细趋势（如上图 ① 所示）：可鼠标拖拽选中该区域，系统会放大显示该区域的趋势信息，双击该趋势图可恢复。

     * 隐藏其他细分指标的数据（如上图 ② 所示）：单击其他细分指标标识，使其置灰，趋势图中将不展示该指标信息。

     * 查看某时刻详细数据（如上图 ③ 所示）：鼠标悬停于趋势图中某时刻。

   * 放大某一趋势图：单击趋势图右上角的放大图标。上述 ①、②、③ 的功能在放大的趋势图中同样适用。

## 指定集群下租户的性能监控

可以在 OCP 上查看某个集群下工作负载最高的 5 个租户的性能信息。

1. 登录 OCP。

2. 在 **集群** 页面的 **集群列表** 区域，选择待操作的集群并单击其集群名。

3. 在显示的页面的左侧导航栏上，单击 **租户管理** 。

4. 在 **租户管理** 的 **租户监控 TOP5** 区域，可以查看当前集群下工作负载最高的 5 个租户的性能信息，包含 **TPS** 、 **QPS** 、 **SQL 响应时间** 、 **事务响应时间** 、 **活跃会话数** 、 **事件等待_次数** 、 **事件等待_时间** 、 **容量_表数量** 、 **容量_分区数量** 等性能监控指标。

   可以根据业务需要，选择待查看的性能指标和对应的时间范围。单击右上角图标，可对图标进行放大查看。

   ![1](http://icms-x-dita.oss-cn-zhangjiakou.aliyuncs.com/xdita-output/zh-CN/task18756973/images/p167602.png?Expires=7258130666&OSSAccessKeyId=LTAIJfoPL6wmrirR&Signature=QM3vVA0zJiOZyaHjCM%2F9SjbePAU%3D#crop=0&crop=0&crop=1&crop=1&id=k8BSx&originHeight=306&originWidth=646&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=)

   性能监控指标相关说明如下表所示：

   |   指标名    |            说明            |            数据来源             |
   |----------|--------------------------|-----------------------------|
   | QPS      | 平均每秒处理的 SQL 语句的次数 (次/s)  | `v$sysstat`                 |
   | TPS      | 平均每秒处理事务的次数 (次/s)        | `v$sysstat`                 |
   | SQL 响应时间 | 服务端每条 SQL 语句的平均处理耗时 (us) | `v$sysstat`                 |
   | 事务响应时间   | 服务端每个事务平均处理耗时 (us)       | `v$sysstat`                 |
   | 活跃会话数    | 当前活跃会话数 (个)              | `__all_virtual_processlist` |
   | 事件等待_次数  | 每秒等待事件的次数 (次/s)          | `v$system_event`            |
   | 事件等待_时间  | 每个等待事件的平均耗时 (us)         | `v$system_event`            |
   | 容量_表数量   | 表数量（个）                   | `gv$table`                  |
   | 容量_分区数量  | 分区数量（个）                  | `v$partition`               |

   > **说明**
   >
   > 该集群下某个租户中的某个性能指标值激增，可在该租户中的 **性能监控** 页面，通过关联关系找到指标值激增的主机。详细信息请参见下文中的 **指定租户的性能监控** 。

## 指定租户的性能监控

* 登录 OCP 。

* 在左侧导航栏上，单击 **租户** 。

* 在 **租户列表** 中，单击待查看的租户的租户名，进入租户 **总览** 页面。

* 在左侧导航栏上，单击 **性能监控** 。

* 在 **数据筛选** 区域，根据多种维度对租户的性能信息进行筛选。

  关闭 **实时** ：输入过滤条件后，系统按 **选择的时间** 及 **统计周期** 展示性能监控数据。

  打开 **实时** ：选择统计范围，系统实时展示该统计范围内的性能监控数据。

  筛选条件说明如下表所示：
  
  |   **过滤条件**    |                                                                                **描述**                                                                                |
  |---------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------|
  | 选择时间（又称：监控窗口） | 实时模式下不展示。 选择某一段时间范围，用于返回这段时间范围内的数据。                                                                                                                  |
  | 统计周期          | 主要用于计算每个点数据的统计周期，支持按 **每分钟** 和 **每秒** 进行统计，分别对应了每分钟一个点或每秒钟一个点，同时 OCP 也会根据选择的时间区间再去计算一个统计周期。 计算的规则是使返回的数据接近 1440 个点，如果选择的时间区间比较长，可能会出现统计周期大于 1 分钟的情况。 |
  | 统计范围          | 指定统计范围为某个 Zone 或某一 Zone 下的某一 OBServer。默认统计所有 Zone 的监控数据。                                                                                                             |

  ![1](http://icms-x-dita.oss-cn-zhangjiakou.aliyuncs.com/xdita-output/zh-CN/task18756973/images/p167621.png?Expires=7258130666&OSSAccessKeyId=LTAIJfoPL6wmrirR&Signature=F%2B4u3H%2FawzNeap59UC5Mra%2FY5q0%3D#crop=0&crop=0&crop=1&crop=1&id=DwIJP&originHeight=139&originWidth=646&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=)

* 分别在 **性能与 SQL** 、 **事务** 、 **存储与缓存** 页签中查看租户的性能监控数据。

  * 在 **性能与 SQL** 页签查看租户的以下性能监控数据：

    * QPS：平均每秒处理 SQL 语句的次数

    * 响应时间：响应时间（us）

    * 活跃会话数：活跃的会话数量（个）

    * SQL 执行计划类别：SQL 执行计划的类别

    * 等待事件：每秒等待事件次数 （次/s）

    * 等待事件耗时：等待事件平均耗时（us）

    * 请求等待队列：每秒 SQL 进入等待队列个数（次/s）

    * 请求等待队列耗时：SQL 请求在等待队列中的等待耗时（us）

    * CPU 使用率：CPU使用率 (%)

    * MEMStore 使用率：MEMStore 使用率 (%)

    * Rpc 包耗时：Rpc 收、发包耗时

    * Rpc 包吞吐量：单位时间内 Rpc 收、发包 byte 数据量

  * 在 **事务** 页签查看租户的以下性能监控数据：

    * TPS：平均每秒处理事务数（次/s）

    * 事务响应时间：服务端每个事务平均处理时间（us）

    * 事务日志数：每秒提交的事务日志数（次/s）

    * 事务日志量：每秒提交的事务日志大小 （byte）

    * 事务日志耗时：服务端处理事务日志的平均耗时（us）

    * 锁等待：每秒事务锁等待次数

    * 等锁耗时：每个锁等待平均耗时（us）

  * 在 **存储与缓存** 页签，查看租户的以下性能监控数据：

    * MEMStore：OceanBase 数据库可写入数据内存（Mb）

    * IOPS：平均每秒 IO 次数（次/s）

    * IO 耗时：平均每次 IO 耗时（us）

    * IO 吞吐率：平均每秒 IO 数据量（byte）

    * 缓存大小：缓存大小（MB）

    * 缓存命中率：缓存命中率（%）

  下述功能能够帮您更好地在趋势图中查看和分析详细性能监控数据，您可结合图片及下述文字理解。
  
  ![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer/V3.1.3/zh-CN/operation-and-maintenance-management/administrator-guide-monitoring-and-alerts/use-ocp-to-monitor-databases/2.%E6%8C%87%E5%AE%9A%E7%A7%9F%E6%88%B7%E7%9A%84%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7.png)

  * 筛选数据。

    1. 查看某一指标的在某一时间段的详细趋势：可鼠标拖拽选中该区域，系统会放大显示该区域的趋势信息，双击该趋势图可恢复。

    2. 隐藏其他细分指标的数据：单击其他细分指标标识，使其置灰，趋势图中将不展示该指标信息。

    3. 查看某时刻详细数据：鼠标悬停于趋势图中某时刻。

  * 查看 SQL 请求分析：在 **响应时间** 趋势图中，单击趋势图右上角的 **SQL 请求分析** 图标，可查看请求分析详情，详见《OCP SQL 诊断 》中的 **查看 SQL 请求分析** 。

    **说明**

    仅 **响应时间** 支持查看 SQL 请求分析。
