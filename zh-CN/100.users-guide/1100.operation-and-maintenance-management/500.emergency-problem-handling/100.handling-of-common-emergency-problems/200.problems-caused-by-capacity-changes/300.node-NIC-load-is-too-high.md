节点网卡负载过高
=============================

导致 observer 所在节点网卡负载过高的原因一般和批处理、复制迁移等后台任务相关。处理的思路和 IO 过高的方案类似，通常是任务降级和调整迁移复制相关参数等，本文针对几种不同的情况进行了详细的分析。

应急处理流程
---------------------------

对于 observer 所在节点网卡负载过高的场景，一般从以下几个方面入手处理。

1. 暂停执行中的备份任务。

   您可以通过 OCP 查看当前节点是否正在进行备份，如果是，可以暂停备份，以缓解 网卡负载 压力。具体步骤如下所示。
   1. 在左导航栏单击 **集群** ，进入集群概览页面。

   2. 在集群列表中单击对应的集群，进入新页面后，在左导航栏单击 **备份恢复** 。

   3. 在集群的备份恢复页面，对当前正在备份调度中的集群，进行 **暂停备份** 的操作。后续需要重启备份，可按照如下步骤进行处理。

      1. 暂停备份调度任务：在指定备份调度任务对应的操作列单击 **操作 \> 暂停** ，即可暂停该任务。

      2. 重启备份调度任务：在指定备份调度任务对应的操作列单击 **操作 \> 重启** ，即可重新启动该任务，系统根据预设的时间和周期继续定期发起任务。

2. 暂停执行中的数据导入/导出任务。

   您可以通过 OMS 查看当前节点是否正在进行数据传输任务，如果是的话，可以根据需要将其暂停，缓解 网卡负载 压力后再继续执行。具体操作步骤如下所示。

   在 OMS 在左侧导航栏中单击 **OMS（数据迁移）** \> **数据传输项目列表** 标签以进入数据传输项目列表页面，在数据传输项目列表单击目标项目操作栏中的 **进入项目** 按钮以查看项目详情，在项目详情页面会直接展示迁移任务列表。在迁移任务列表的操作栏中点击 **进入任务** 以进入迁移任务详情页面：
   * **停止：** 停掉编排任务列表中正在运行（RUNNING）状态的子任务并自动终止其后面全部的原子任务调度。

   * **重置** ：将全部原子任务设置为待执行（TODO）状态，以供编排任务全部重新执行。

   更多信息可以参见 [管理迁移任务](https://www.oceanbase.com/docs/oceanbase-migration-service/oms-1-4-2/V1.4.2/pvapnp)。

   您还可以通过 ODC 查看当前节点是否正在进行导数，在 **任务中心** 面板的 **导入** 页签查看任务列表。进入目标数据库连接后，单击上方导航栏中的 **任务** 标签弹出任务中心面板，在面板中单击 **导入** 页签展示任务列表，进入导入任务页签后，可以根据需要进行 **终止** 和 **重试** 操作。更多信息可以参见 [导入任务](https://www.oceanbase.com/docs/oceanbase-developer-center/odc/V3.2.2/import-tasks-2)。

3. 调低迁移复制的并发数。

   当问题发生期间 OB 集群中如果恰好有 unit 迁移，或者副本均衡类的任务。此时可以通过限制迁移的并发数来达到 IO 限流的目的。

   ```sql
   alter system set migrate_concurrency=5;  --默认值为10
   alter system set data_copy_concurrency=5; --默认值为10
   alter system set server_data_copy_in_concurrency=2; --默认值为2，如果高于该值，可以调回2
   alter system set server_data_copy_out_concurrency=2; --默认值为2，如果高于该值，可以调回2
   ```

4. 调低后台任务的网络带宽。

   您可以使用如下命令来调低后台任务的网络带宽：

   ```sql
   alter system set sys_bkgd_net_percentage=30;  --默认值60
   ```


5. 对高负载的SQL执行限流。

   当网卡负载过高，定位到某条 SQL 时，可以通过绑定 SQL 的执行计划加入 hint max_concurrent 来限制 SQL 并发，实现对 SQL 的限流。

   ```sql
   CREATE OUTLINE outline_name ON sql_id USING HINT /*+max_concurrent(1)*/;
   ```

   更多信息请参见 **《SQL 参考（MySQL 模式）》** 中的 **SQL语句** 和 **SQL 参考（Oracle 模式）》** 中的 **SQL语句** 。
