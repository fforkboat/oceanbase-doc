# 租户性能监控

您可以通过 OCP 或者 DOOBA 工具查看租户的性能监控。

## 通过 OCP 查看租户性能

1. 登录 OCP。

2. 选择 **租户** ，进入 **租户** 界面。

3. 在 **租户列表** 区域，选择待操作的租户并单击其租户名。

4. 在显示的页面的左侧导航栏上，单击 **性能监控** 。

5. 在 **数据筛选** 区域，通过如下方式查看性能数据。

   筛选条件说明如下标所示：

   |    **过滤条件**    |               **描述**                |
   |----------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------|
   | 选择时间（实时模式下不展示） | 选择某一段时间范围，用于返回这段时间范围内的数据。           |
   | 统计周期（实时模式下不展示） | 主要用于计算每个点数据的统计周期，支持按 **每分钟** 和 **每秒** 统计，分别对应了每分钟一个点或每秒钟一个点，OCP 同时也会根据选择的时间区间再去计算一个统计周期。 计算的规则是使返回的数据接近 1440 个点，如果选择的时间区间比较长，可能会出现统计周期大于 1 分钟的情况。 |
   | Zone           | 选择待查看的 Zone 。  |
   | OBServer       | 选择待查看的 OBServer 。                   |

   * 输入过滤条件后，系统按 **选择的时间** 及 **统计周期** 展示性能监控数据。
  
      ![06091755](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/7113323261/p282520.png)

     >**说明**
     >
     >如需查看某一时间段内的详细趋势，可鼠标拖拽选中该区域，系统会放大显示该区域的趋势信息，双击该趋势图可恢复。

   * 打开 **实时** 开关并选择需查看的 OBServer，系统实时展示该 OBServer 的性能数据。
  
      ![06091759](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/7113323261/p282527.png)

6. 切换页签，分别查看集群的 **性能与 SQL** 、 **事务** 、 **存储与缓存** 的性能监控数据。

   * 单击 **性能与 SQL** 页签，查看 SQL 执行相关的性能。性能与 SQL 相关的监控项可参考下表理解。

     |     监控项      |                 说明                 |
     |--------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
     | QPS          | 平均每秒处理 SQL 语句数 <ul><li>all: 每秒处理 SQL 语句数 (times/s)</li><li> select: 每秒处理 Select 语句数 (times/s)   </li><li>insert: 每秒处理 Insert 语句数 (times/s)</li><li> update: 每秒处理 Update 语句数 (times/s)   </li><li>replace: 每秒处理 Replace 语句数 (times/s)</li><li> delete: 每秒处理 Delete 语句数 (times/s)  </li></ul>  |
     | 响应时间         | 响应时间 <ul><li>all: 服务端每条 SQL 语句平均处理耗时 (us)</li><li> select: 服务端每条 Select 语句平均处理耗时 (us)   </li><li>insert: 服务端每条 Insert 语句平均处理耗时 (us)</li><li> update: 服务端每条 Update 语句平均处理耗时 (us)   </li><li>replace: 服务端每条 Replace 语句平均处理耗时 (us)</li><li> delete: 服务端每条 Delete 语句平均处理耗时 (us)  </li></ul>       |
     | 活跃会话数        | 活跃的会话数量（个）    |
     | SQL 执行计划类别   | SQL 执行计划类别 <ul><li>local: 每秒处理本地执行数 (times/s)</li><li> remote: 每秒处理远程执行计划数 (times/s)   </li><li> distributed: 每秒处理分布式执行计划数 (times/s)   </li></ul>               |
     | 等待事件         | 每秒等待事件次数 (times/s)                 |
     | 等待事件耗时       | 等待事件平均耗时 (us) |
     | 请求等待队列       | 每秒 SQL 进入等待队列个数 (times/s)          |
     | 请求等待队列耗时     | SQL 请求在等待队列中的等待耗时 (us)             |
     | CPU 使用率      | CPU使用率 (%)    |
     | MemStore 使用率 | MemStore 使用率 (%)                   |
     | RPC 包耗时      | RPC 收、发包耗时 <ul><li>in: RPC 收包平均耗时 (us)</li><li> out: RPC 发包平均耗时 (us)       </li></ul>              |
     | RPC 包吞吐量     | 单位时间内 RPC 收、发包 byte 数据量 <ul><li>in: RPC 收包吞吐量 (byte)</li><li> out: RPC 发包吞吐量 (byte) </li></ul>     |

   * 单击 **事务** 页签，查看事务相关的性能。事务相关的监控项可参考下表理解。

     |  监控项   |          说明          |
     |--------|----------------------|
     | TPS    | 平均每秒处理事务数，单位：次/s。    |
     | 事务响应时间 | 服务端每个事务平均处理时间，单位：us。 |
     | 事务日志数  | 每秒提交的事务日志数（次/s）      |
     | 事务日志量  | 每秒提交的事务日志大小 （byte）   |
     | 事务日志耗时 | 服务端处理事务日志的平均耗时（us）   |
     | 锁等待    | 每秒事务锁等待次数            |
     | 等锁耗时   | 每个锁等待平均耗时（us）        |

   * 单击 **存储与缓存** 页签，查看存储与缓存相关的性能。存储与缓存相关的监控项可参考下表理解。

     |   监控项    |             说明             |
     |----------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
     | MemStore | 当前租户可写入数据内存 <ul><li>total: MemStore 总大小 (MB)</li><li> active: 活跃 MemStore 大小 (MB)   </li><li>trigger: 触发合并阈值 (MB)</li><li> limit: MEMStore的limit (MB)  </li></ul>  |
     | IOPS     | 平均每秒 IO 次数 <ul><li>read: SSStore 每秒读次数 (times/s)</li><li> write: SSStore 每秒写次数 (times/s)    </li></ul>          |
     | IO 耗时    | 平均每次 IO 耗时 <ul><li> read: SSStore 每次读取平均耗时 (us)</li><li> write: SSStore 每次写入平均耗时 (us)   </li></ul>               |
     | IO 吞吐量   | 平均每秒 IO 数据量 <ul><li>read: SSStore 每秒读取数据量 (byte)</li><li> write: SSStore 每秒写入数据量 (byte) </li></ul>              |
     | 缓存大小     | 缓存大小 <ul><li>block_cache: 块缓存大小 (MB)</li><li> row_cache: 行缓存大小 (MB)   </li><li> plan_cache: 执行计划缓存大小 (MB)     </li></ul>         |
     | 缓存命中率    | 缓存命中率 <ul><li>block_cache: 块缓存命中率 (%)</li><li> row_cache: 行缓存命中率 (%)   </li><li> plan_cache: 执行计划缓存命中率 (%)       </li></ul>      |

## 通过 DOOBA 查看租户性能

DOOBA 是 OceanBase 数据库内部的一个运维脚本，使用 Python 语言开发，可通过 DOOBA 对 OceanBase 数据库进行性能监控。详细的介绍和使用，请参考 [DOOBA](../../../18.supporting-tools/7.dooba.md)。

使用 DOOBA 查看用户性能的具体操作如下：

1. 将 DOOBA 脚本文件 [dooba.py](https://github.com/oceanbase/oceanbase/blob/master/tools/scripts/dooba.py) 下载到可访问数据库的设备上。

2. 在设备命令行界面通过以下方式运行脚本，登录并获取数据库租户性能数据。

    ```sql
    python dooba.py -h OBPROXY地址 -u root@sys#集群名 -P OBPROXY端口 -p密码
    // 例如：
    python dooba.py -h 172.20.*.* -u root@sys#obce-3zones -P 2883 -pxxxxxx
    ```

    >**注意**
    >
    >dooba.py 脚本运行需要 Python 2.7 环境。

   登录后常用的快捷键如下：

   * `c`：选择租户，一般是观察业务租户的性能。
   * `1`：查看快捷键。

     > **注意**
     >
     > 快捷键界面中没有提到的快捷键尽量不要使用，我们不保证其功能正确。

   * `2`：查看租户性能概览。
   * `3`：查看租户各个节点的性能概览，但如果节点很多则会显示不全。
   * `tab`：在各个 widget 之间跳转。
   * `d`：删除 tab 焦点所在的 widget。
   * `R`：恢复当前界面所有的 widget 布局（包括被删除的）。

3. 执行成功后可看到如下租户性能概览界面。

   ![租户性能图](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer/V3.1.3/zh-CN/Tools/DOOBA/7.dooba%E7%A7%9F%E6%88%B7%E6%80%A7%E8%83%BD%E5%9B%BE.png)

   |监控项|说明|
   |-----|----------------|
   |SQL COUNT|QPS 信息，包括各类 SQL 语句的每秒执行次数。SQL 类型分别为 select、insert、update、delete、replace、commit、rollback。其中，前四类 SQL 总数和 commit 的比值大致可以推出事务的平均语句数。rollback 是回滚的信息，如果太高，很有可能是数据库有问题或者业务设计有问题。|
   |SQL RT|SQL 每次执行的平均耗时，包括各类 SQL 语句的每次执行的平均耗时，单位为毫秒（ms）。SQL 类型分别为 select、insert、update、 delete、replace、commit。|
   |RPC|反馈网络信息，后续待完善，您暂时可不用关注。|
   |Memory|Memstore 内存的实时监控。默认情况下，租户可用内存的一半用于 Memstore 的内存，用于存放业务写操作的增量数据。|
   |IOPS|磁盘 IO 的实时监控。|
