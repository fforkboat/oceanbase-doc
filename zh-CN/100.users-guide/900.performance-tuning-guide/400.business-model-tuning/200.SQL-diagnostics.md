# SQL 诊断

压测环境中的 SQL 执行效率，一定程度上决定了系统的性能，因此 SQL 诊断是性能调优过程中最重要的一个环节，本文主要介绍如何定位并优化慢 SQL。

## 视图统计

根据 plan cache 的统计，找出高频的 SQL 类别：

```sql
MySQL [oceanbase]> select plan_id, sql_id, hit_count, avg_exe_usec, substr(statement, 1, 100) from gv$plan_cache_plan_stat where tenant_id=1002 order by hit_count desc limit 10;
+---------+----------------------------------+-----------+--------------+------------------------------------------------------------------------------------------------------+
| plan_id | sql_id                           | hit_count | avg_exe_usec | substr(statement, 1, 100)                                                                            |
+---------+----------------------------------+-----------+--------------+------------------------------------------------------------------------------------------------------+
|     277 | 7222544C4715703B717FAFF8E69B4480 |       539 |            0 | SELECT MAX(schema_version) as version, host_ip() as myip, rpc_port() as myport FROM __all_ddl_operat |
|     431 | CD7AC61B2434CF86FDBE9C3A7A44BB8E |       371 |            0 | INSERT INTO sbtest9(k, c, pad) VALUES(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, |
|     442 | 136C85D11DD21EFB5E1ED5FC901DEC6A |       371 |            0 | INSERT INTO sbtest10(k, c, pad) VALUES(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(? |
|     411 | C366417982B5BCEAE5C8C1EF48C1B8E2 |       371 |            0 | INSERT INTO sbtest8(k, c, pad) VALUES(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, |
|     421 | 77E9B2275B22581798AB612E9B5B96E6 |       371 |            0 | INSERT INTO sbtest13(k, c, pad) VALUES(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(? |
|     439 | B8778DBBDF6C08CB6F0E1A82986F1D0E |       371 |            0 | INSERT INTO sbtest17(k, c, pad) VALUES(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(? |
|     452 | BE6FD8B551DA05119B49D62FB165AE02 |       371 |            0 | INSERT INTO sbtest16(k, c, pad) VALUES(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(? |
|     418 | 8462CC36B2F5186B02F066CEFD214387 |       370 |            0 | INSERT INTO sbtest5(k, c, pad) VALUES(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, |
|     430 | 6753D592D51B5630EBF36F43FA5522D3 |       370 |            0 | INSERT INTO sbtest7(k, c, pad) VALUES(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, |
|     429 | 20D6D195029E9EE68B0C8B3C7DD8C846 |       370 |            0 | INSERT INTO sbtest3(k, c, pad) VALUES(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, ?, ?),(?, |
+---------+----------------------------------+-----------+--------------+------------------------------------------------------------------------------------------------------+
10 rows in set (0.01 sec)
```

根据具体的 SQL_ID，采样一段时间内的执行数据，具体 SQL 如下：

```sql
MySQL [oceanbase]> select svr_ip, plan_type, elapsed_time, AFFECTED_ROWS, RETURN_ROWS, transaction_hash, usec_to_time(REQUEST_TIME), substr(query_sql, 1, 30) from gv$sql_audit where sql_id='F96CE9DFB959E383828A9D91575EE97F' and request_time > time_to_usec('2021-08-25 22:00:00') and request_time < time_to_usec('2021-08-25 22:50:00') order by elapsed_time desc limit 10;
+---------------+-----------+--------------+---------------+-------------+----------------------+----------------------------+--------------------------------+
| svr_ip        | plan_type | elapsed_time | AFFECTED_ROWS | RETURN_ROWS | transaction_hash     | usec_to_time(REQUEST_TIME) | substr(query_sql, 1, 30)       |
+---------------+-----------+--------------+---------------+-------------+----------------------+----------------------------+--------------------------------+
| 192.168.30.59 |         1 |       465114 |             0 |           0 | 10023348016566894972 | 2021-08-25 22:44:08.533070 | SELECT * FROM __all_root_table |
| 192.168.30.59 |         1 |       375107 |             0 |           0 | 13001988804803062059 | 2021-08-25 22:44:08.573525 | SELECT * FROM __all_root_table |
| 192.168.30.62 |         2 |       226940 |             0 |           0 |                    0 | 2021-08-25 22:44:08.722480 | SELECT * FROM __all_root_table |
| 192.168.30.62 |         2 |       224519 |             0 |           0 |                    0 | 2021-08-25 22:44:08.730139 | SELECT * FROM __all_root_table |
| 192.168.30.59 |         1 |       220272 |             0 |           0 |  6454906702768493748 | 2021-08-25 22:44:08.745529 | SELECT * FROM __all_root_table |
| 192.168.30.63 |         2 |        78577 |             0 |           0 |                    0 | 2021-08-25 22:44:08.884916 | SELECT * FROM __all_root_table |
| 192.168.30.63 |         2 |        49034 |             0 |           0 |                    0 | 2021-08-25 22:44:08.905322 | SELECT * FROM __all_root_table |
| 192.168.30.62 |         2 |        48885 |             0 |           0 |                    0 | 2021-08-25 22:44:08.905610 | SELECT * FROM __all_root_table |
| 192.168.30.59 |         1 |        45239 |             0 |           0 | 11958340144270554107 | 2021-08-25 22:44:08.906159 | SELECT * FROM __all_root_table |
| 192.168.30.63 |         2 |        33454 |             0 |           0 |                    0 | 2021-08-25 22:44:08.920650 | SELECT * FROM __all_root_table |
+---------------+-----------+--------------+---------------+-------------+----------------------+----------------------------+--------------------------------+
10 rows in set (0.20 sec)
```

具体的 SQL 写法，可以结合实际需求来调整。

## OCP 监控

OCP 目前已经有完善的慢 SQL 分析，包括：执行计划、执行频率、耗时等。通过 OCP 能大大提高效率，快速定位慢 SQL 的相关信息。

## SQL 调优

确定慢 SQL 之后，需要从以下几个方面进行排查：

- 租户资源是否充足？
- 索引或计划是否相对最优？
- 确定 affected rows 、return rows 大小，确定写入或查询涉及的分区数、行数是否较多？
- 是否存在跨城访问、跨机访问？
- 对于较为复杂的 SQL，可能有中间结果 dump 到磁盘，需要确认是否符合预期？
- 系统层面排查：确认转储、磁盘 IO 使用率等。

有关 SQL 调优的详细介绍，请参见 [SQL 调优指南](../500.sql-tuning-guide/100.execution-process-of-sql-queries.md)。
