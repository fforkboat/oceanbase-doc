# Go-SQL-Driver/MySQL 连接 OceanBase 数据库示例程序

本文介绍 Go 应用程序示例如何通过驱动 Go-SQL-Driver/MySQL 连接并使用 OceanBase 数据库。

## 前提条件

安装 Go 和 OceanBase 数据库，并确保已经正确配置了环境变量。

* 安装 Go 语言

    1. 下载 Go 语言安装包：可以从 [Go 官网](https://golang.org/dl/) 下载适合自己操作系统的安装包。

    2. 安装 Go 语言：双击下载的安装包，按照提示进行安装。

    3. 配置环境变量：将 Go 语言的安装路径添加到系统的 PATH 环境变量中。
       * 在 Windows 环境中，可以在 **控制面板 > 系统和安全 > 系统 > 高级系统设置 > 环境变量** 中增加 Path 的值为 `C:\usr\local\go\bin`。
       * 在 Linux 或 macOS 环境中，可以编辑 `~/.bashrc` 或 `~/.bash_profile` 文件，在其中添加以下内容：

            ```shell
            export PATH=$PATH:/usr/local/go/bin
            ```

        <main id="notice" type='explain'>
         <h4>说明</h4>
         <p><code>\usr\local\go\bin</code>为默认安装目录，若在安装 Go 语言时修改了安装目录，请替换为对应的目录。</p>
        </main>

    4. 验证安装：在 Shell 命令行中输入以下命令，查看 Go 语言的版本信息，以验证安装是否成功：

        ```shell
        C:\Users\admin\> go version
        go version go1.20.6 windows/amd64
        ```

* 安装 OceanBase 数据库

## 创建 Go 应用程序

### 步骤一：获取数据库连接串

联系 OceanBase 数据库部署人员或者管理员获取相应的数据库连接串，例如：

```sql
obclient  -hxxx.xxx.xxx.xxx -uroot@test -p****** -P2881 -Doceanbase
```

数据库连接串包含了访问数据库所需的参数信息，在创建应用程序前，可通过数据库连接串验证登录数据库，保证连接串参数信息正确。

参数说明：

* **-h**：OceanBase 数据库连接 IP，有时候是一个 ODP 地址。
* **-u**：租户的连接用户名，格式为 **用户@租户#集群名称**，集群的默认租户是 'sys'，租户的默认管理员用户是 'root'。直接连接数据库时不填集群名称，通过 ODP 连接时需要填写。
* **-p**：用户密码。
* **-P**：OceanBase 数据库连接端口，也是 ODP 的监听端口。
* **-D**：需要访问的数据库名称。

### 步骤二：创建 Go 项目代码

在本地创建一个文件名为 go-oceanbase 的文件夹。也可通过点击 [go-oceanbase]([待添加](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/observer-enterprise/V4.2.0/3.develop/demo/Go/go-oceanbase.zip)) 下载项目代码。
在项目目录下创建以下文件：

```shell
|-- go.mod
|-- go.sum
|-- test.go
```

文件名说明：
go.mod：Go 语言模块文件，用于管理项目依赖。
go.sum：Go V1.11 及以上版本中新增的模块管理文件，用于记录项目依赖的模块及其版本信息，以及对应的校验和（Checksum）。
test.go：主程序。

### 步骤三：创建项目依赖

#### 创建 Mod 文件

创建 go.mod 的文件，用于管理项目依赖。

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>Go V1.11 及以上版本需要安装。</p>
</main>

在项目目录下打开命令行终端，运行以下命令安装项目依赖：

```shell
C:\Users\admin\Desktop\go-oceanbase>go mod init go-oceanbase
go: creating new go.mod: module go-oceanbase
go: to add module requirements and sums:
        go mod tidy
```

#### 安装 Go-SQL-Driver/MySQL 驱动

创建 go.sum 文件，用于记录项目依赖的模块及其版本信息。

根据 Go 语言的不同版本，可以选择不同的安装方式。关于 `Go-SQL-Driver/MySQL` 的详细信息，您可参考 [Github](https://github.com/go-sql-driver/mysql)。

安装命令如下：

```shell
C:\Users\admin\Desktop\go-oceanbase>go get -u github.com/go-sql-driver/mysql
go: downloading github.com/go-sql-driver/mysql v1.7.1
go: added github.com/go-sql-driver/mysql v1.7.1
```

如果由于版本或网络的原因，无法通过 `go get` 命令安装时，可通过 `go install` 命令进行 `go-sql-driver/mysql` 安装。

1. 在 `go/src` 目录克隆 github 中的 `go-sql-driver/mysql` 仓库。

    ```bash
    cd /usr/local/go/src   
    git clone https://github.com/go-sql-driver/mysql.git 
    ```

   <main id="notice" type='notice'>
     <h4>注意</h4>
     <p><code>/usr/local/go/src</code> 需要替换成 Go 实际安装目录操作。</p>
   </main>

2. 通过 `go install` 进行安装。

    ```bash
    go install mysql
    ```

   <main id="notice" type='notice'>
     <h4>注意</h4>
     <p>部分版本 <code>go install</code> 的默认执行目录可能不是 <code>/src</code>，可以通过 <code>go install</code> 执行后的报错判断实际目录。例如，报错 <code>cannot find package &quot;mysql&quot; in: /usr/local/go/src/vendor/mysql</code>，则应该将 mysql 文件夹放在 <code>/src/vendor</code> 目录下再执行安装命令。</p>
   </main>

### 步骤四：编写应用程序

在 `go-oceanbase` 目录下创建一个名为 `test.go` 的文件，用于编写项目的主要代码。代码如下：

```go
package main

import (
  "database/sql"
  "fmt"
  "log"

  _ "github.com/go-sql-driver/mysql"
  // 填写 go-sql-driver/mysql 的安装路径。
)

type Str struct {
  Name string
}

func main() {
  selectAll()
}

func selectAll() {
  conn := "root@mysql:******@tcp(xxx.xxx.xxx.xxx:2880)/test"
  // 数据库连接参数
  db, err := sql.Open("mysql", conn)
  if err != nil {
    log.Fatal(err)
  }
  defer db.Close()

  if err != nil {
    log.Fatal(err)
  }

  fmt.Printf("success to connect OceanBase with go_mysql driver\n")
  // 创建表 t1
  _, err = db.Query("create table t1(str varchar(256))")
  if err != nil {
    log.Fatal(err)
  }

  // 插入数据
  _, err = db.Query("insert into t1 values ('Hello OceanBase')")
  if err != nil {
    log.Fatal(err)
  }

  // 查询数据
  res, err := db.Query("SELECT * FROM t1")
  if err != nil {
    log.Fatal(err)
  }
  defer res.Close()

  for res.Next() {
    var str Str
    res.Scan(&str.Name)
    fmt.Printf("%s\n", str.Name)
  }

  // 删除表 t1
  _, err = db.Query("drop table t1")
  if err != nil {
    log.Fatal(err)
  }
}
```

其中数据库连接参数需要修改。参考如下字段及拼接方法，各字段所对应的值可通过步骤一获取。

```go
conn := "{username}:{password}@tcp({hostname}:{port})/{dbname}"
```

参数说明：

* **username**：取自 `-u` 参数，租户的连接用户名，格式为 **用户@租户#集群名称**，集群的默认租户是 'sys'，租户的默认管理员用户是 'root'。直连数据库时不填写集群名称，通过 ODP 连接时需要填写。

* **password**：取自 `-p` 参数，用户密码。

* **hostname**：取自 `-h` 参数，OceanBase 数据库连接地址，有时候是 ODP 地址。

* **port**：取自 `-P` 参数，OceanBase 数据库连接端口，也是 ODP 的监听端口。

* **dbname**：取自 `-D` 参数，需要访问的数据库名称。

### 步骤五：运行项目程序

代码编辑完成后，在项目目录下打开命令行终端，通过 `go run` 直接运行 Go 文件运行如下命令运行：

```shell
C:\Users\admin\Desktop\go-oceanbase>go run main.go
```

（可选）在 Linux 或 macOS 环境中需要配置临时环境变量后，才能运行 `go run`。

```shell
export PATH=$PATH:/usr/local/go/bin
go run test.go
```

运行后返回如下内容，说明数据库连接成功，示例语句正确执行：

```shell
C:\Users\admin\Desktop\go-oceanbase>go run test.go
success to connect OceanBase with go_mysql driver
Hello OceanBase
```

## 更多信息

有关 Go-SQL-Driver/MySQL 的内容在 OceanBase 数据库开源社区中也有更多信息，详情请参考 [Go-SQL-Driver/MySQL](https://github.com/go-sql-driver/mysql#installation)。
