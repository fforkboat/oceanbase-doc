# 新建集群
#docslug#/oceanbase-database/oceanbase-database/V4.0.0/create-a-cluster-2
OceanBase 数据库部署成功后，默认已创建集群，如果您需要添加新的集群，可通过 OBD 或 OCP 来进行创建，本文将为您讲解如何使用 OBD 和 OCP 创建集群。

## 使用 OCP 新建集群

### 前提条件

当前登录用户必须拥有 **CLUSTER_MANAGER** 角色权限，如果当前用户没有该角色权限，请联系管理员为您添加，具体操作方法请参见 OCP 对应版本的《用户指南》文档中的 **编辑用户** 。

### 操作步骤

您可以通过 OCP 添加机器、上传 OceanBase 数据库的 RPM 包并新建集群。

1. 登录 OCP 后，根据实际业务场景，找到新建集群的入口。

   * 如果您没有可管理的集群，系统会在 **集群** 页面提示您新建集群，直接在提示信息中单击 **创建集群** 。

   * 如果您已经有可管理的集群，则在 **集群** 页面右上角，单击 **新建集群** 。

2. 在 **新建集群** 页面，设置集群的基础信息。

   ![新建 OceanBase 集群](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/1189699361/p336432.png)

   基础信息填写说明如下表所示。

   |        配置         |        描述         |
   |-------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
   | **集群类型**          | 选择 **主集群** 。      |
   | **集群名称**          | 自定义待管理的集群的名称。集群名称需保证全局唯一性，且必须以英文字母开头，可支持大小写字母、数字和下划线，长度为 2\~48 字符。   |
   | **root@sys密码**    | 支持自定义或随机生成。 密码需要满足以下复杂度条件： <ul><li>长度：8 位 \~ 32 位* 至少包含 2 个数字、2 个大写字母、2 个小写字母和 2 个特殊字符。</li>    <li>支持的特殊字符如下： ._+@#$%) </li></ul>                 |
   | **OB 版本**         | 可以从列表中选择已有的 OceanBase 数据库版本，也可以在列表下方单击 **添加版本** ，上传一个 OceanBase 数据库版本的 RPM 包。            |
   | **关联 OBProxy 集群** | 打开关联 OBProxy 集群开关，可以选择当前已有的 OBProxy 集群进行关联： <ol><li>默认使用 `proxyro` 用户关联，无需填写用户名和密码。</li>   <li>在下拉框中选择要关联的 OBProxy 集群。 </br>如果下拉框中没有可关联的 OBProxy 集群，则需要创建OBProxy 集群，具体操作请参见 [创建集群](../../5.database-connection-and-routing/2.obproxy-management/2.manage-obproxy-clusters/1.create-an-obproxy-cluster.md)。</li></ol>    </br>关联后，您的业务涉及的 SQL 请求将会被精准转发到相应的副本，使您对 OceanBase 数据库的访问效果能够媲美访问单机数据库。 |

3. 设置集群的部署模式信息。

   默认添加 3 个 Zone 的信息，如果您希望部署的集群 Zone 的个数大于 3个，您可以在下方单击 **新增** 按钮，增加 Zone 信息。如果部署的集群 Zone 的个数小于 3 个，您可以单击 Zone 后面的删除图标。

   ![10](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/1772988061/p200714.png)

   每个 Zone 需要设置的信息及其说明如下表所示。

   |         配置         |         描述         |
   |--------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
   | **Zone 名称**        | 可保持默认也可自定义。 Zone 名称需保证租户内唯一，且必须以英文字母开头，支持大小写字母、数字和下划线，长度为 2\~48。       |
   | **机房**             | Zone 所在的机房，每个 Zone 只能部署在同一个机房。      |
   | **机型**             | 可选项。 如果选择了机型，后面主机列表会根据机型进行过滤。        |
   | **机器选择方式**         | 可选择 **自动分配** 或者 **手动选择** 。          |
   | **IP**             | 您可以选择多个 IP。 <ul><li>如果 **机器选择方式** 是 **自动分配** ，则只需要输入机器的数量，OCP 会自动选择相应数量的可用机器；</li> <li>如果 **机器选择方式** 是 **手动选择** ，则需要您手动从列表中选择若干个 IP。</li></ul>   |
   | **Root Server 位置** | 您可以选择一个 IP 作为 root Server 所在的机器。    |
   | **优先级排序**          | Zone 的优先级排序。该优先级顺序影响 sys 租户 Primary Zone 的优先级顺序。 排序方法： <ol><li>勾选左侧列表框中的一个或多个 Zone。 左侧列表框中显示了当前集群中所有可选的 Zone。</li>   <li>单击中间的 \> 按钮。 </br>此时勾选的 Zone 就会被移动到 **优先级排序** 列表中。同时勾选的多个 Zone 具有相同的优先级。</li>   <li>重复前面的操作，添加低一优先级的 Zone。</li>   <li>如需调整优先级，可在 **优先级排序** 列表中拖拽以调整顺序。 列表中从上到下，优先级依次递减。</li></ol>    |

4. 打开 **参数设置** ，对启动参数的值进行修改。

   ![09161737](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/1950562361/p327381.png)

   更多集群参数的详细信息，请参见《参考指南》文档中的 [系统配置项](../../../7.reference/5.system-configuration-items/1.system-configuration-items-overview-2.md)。

5. 配置 **安装路径设置** 。

   ![1](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/7370730261/p268993.png)

   根据需要自定义 **软件安装路径、数据盘路径** 和 **日志路径** 。

6. 单击 **测试** 。

   如果测试失败，请根据提示信息尝试修改。

7. 测试成功后，单击 **提交** 。

8. 在弹出的 **确认提交信息** 对话框中，确认信息无误后，单击 **确定** 。

   系统开始创建集群，您可在 OCP 的 **系统管理 \> 任务** 中查看该任务的执行进度。

   OceanBase 集群大约需要 12 分钟才能创建成功，请您耐心等待。

## 使用 OBD 新建集群

### 前提条件

* 您的机器满足软硬件要求。详细信息请参考 [软硬件要求](../../../4.installation-and-deployment/2.local-deployment/1.requirements-for-software-and-hardware.md)。

* 您的机器可以连接公网

  若您的机器不能连接公网，您需手动下载 RPM 包并进行配置。

* 您已在中控机器上安装了 OBD。

### 操作步骤

1. 从 OBD 安装目录 `/usr/obd/example` 上复制对应的配置文件模板。

2. 根据自身机器情况修改配置文件，配置文件各个模块的含义可参考 [配置文件说明](https://www.oceanbase.com/docs/community-obd-cn-10000000000768413)。

3. 执行命令如下部署集群：

   ```bash
   obd cluster deploy <deploy_name> -c <deploy_config_path>
   ```

   其中，参数 `deploy_name` 为部署集群名称，可以理解为配置文件的别名，`deploy_config_path` 为配置文件名。

   此命令会检查 home_path 和 data_dir 指向的目录文件是否为空，若目录文件不为空，则报错。此时可以加上 `-f` 选项，强制清空目录文件。

   在您执行了 `obd cluster deploy` 命令之后，OBD 将检查您的目标机器是否有 OceanBase 数据库安装包。如果没有安装包，OBD 将自动从 yum 源获取。

4. 运行以下命令启动集群：

   ```bash
   obd cluster start <deploy_name>
   ```

   此命令会检查系统参数 `fs.aio-max-nr` 是否不小于 1048576。通常情况下一台机器启动一个节点不需要修改 `fs.aio-max-nr`。但当一台机器需要启动 4 个及以上的节点时，请务必修改 `fs.aio-max-nr`。详细信息请参考 [（可选）配置 sysctl.conf](../../../4.installation-and-deployment/2.local-deployment/2.environment-and-configuration-checks.md)。

5. 运行以下命令查看集群状态：

   ```bash
   obd cluster display <deploy_name>
   ```

6. 验证集群。

   连接 OceanBase 数据库，运行以下命令验证集群：

   ```sql
   MySQL [oceanbase]> SELECT * FROM oceanbase.DBA_OB_SERVERS;
   ```

   若返回如下结果说明集群部署成功：

   ```sql
   +----------------+----------+----+-------+----------+-----------------+--------+----------------------------+-----------+-----------------------+----------------------------+----------------------------+--------------------------------------------------------------------------+
   | SVR_IP         | SVR_PORT | ID | ZONE  | SQL_PORT | WITH_ROOTSERVER | STATUS | START_SERVICE_TIME         | STOP_TIME | BLOCK_MIGRATE_IN_TIME | CREATE_TIME                | MODIFY_TIME                | BUILD_VERSION                                                            |
   +----------------+----------+----+-------+----------+-----------------+--------+----------------------------+-----------+-----------------------+----------------------------+----------------------------+--------------------------------------------------------------------------+
   | xxx.xx.xxx.xxx |     2882 |  1 | zone1 |     2881 | YES             | ACTIVE | 2022-10-12 14:24:46.697072 | NULL      | NULL                  | 2022-09-30 17:28:06.385664 | 2022-10-12 14:24:48.694768 | 4.0.0.0_1-bf312c84fa50e378b14a786e0e8b7044bb7e4d6d(Sep 21 2022 10:53:34) |
   | xxx.xx.xxx.xxx |     2882 |  2 | zone2 |     2881 | NO              | ACTIVE | 2022-10-12 14:36:16.947719 | NULL      | NULL                  | 2022-10-12 14:36:06.286150 | 2022-10-12 15:00:38.203863 | 4.0.0.0_1-bf312c84fa50e378b14a786e0e8b7044bb7e4d6d(Sep 21 2022 10:53:34) |
   +----------------+----------+----+-------+----------+-----------------+--------+----------------------------+-----------+-----------------------+----------------------------+----------------------------+--------------------------------------------------------------------------+
   3 rows in set (0.005 sec)
   ```
