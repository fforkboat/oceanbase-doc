# 使用 OMS 迁移数据

OceanBase 迁移服务（OceanBase Migration Service，OMS）支持数据迁移功能，您可以通过该功能实时迁移其它数据源的数据至 OceanBase 数据库，以及迁移 OceanBase 数据库的数据至其它数据源。

## 背景信息

OMS 数据迁移支持在线迁移，OMS 部署服务器需要能够同时与源实例和目标实例保持网络连通，您只需要配置好待迁移的源端数据源和目标数据源，选择需要迁移的对象后，即可启动数据迁移任务。

OMS 自动执行数据迁移任务的全部流程，成功复制源端数据库（数据表）中的数据库对象、存量数据或增量数据至目标端数据库（数据表），并确保源库至目标库的实时增量同步。

## 使用限制

有关 OMS 数据迁移和数据同步功能使用限制的详细信息，请参见 [使用限制](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091381)。

## 支持的迁移类型

| **迁移类型** |   **描述**  |
|--------------|---------------------------------------------------|
| 结构迁移     | 负责迁移源库中的数据对象定义（表、索引、约束、注释和视图等）至目标端数据库中，会自动过滤临时表。 <br>当源端数据库非 OceanBase 数据库时，会依据目标 OceanBase 租户类型的语法定义标准进行数据类型和 SQL 语法的自动转换和拼装，然后复制至目标库中。    |
| 全量迁移     | 迁移源库表的存量数据至目标端数据库对应的表中。您可以在 **全量迁移** 页面，查看 **表对象**、**表索引** 和 **全量迁移性能**。只有表对象和表索引均迁移完成，全量迁移的状态才会显示已完成。<br>在 **表索引** 页面，单击目标表对象后的 **查看创建语法**，即可查看索引创建语法。 <br>全量迁移加上增量同步，可以确保目标端数据库与源端数据库的最终一致性。如果全量迁移过程中有失败的对象，会为您展示具体的失败原因。       |
| 增量同步     | 增量同步任务开始后，会同步源库发生变化的数据（新增、修改或删除）至目标端数据库对应的表中。<br> 当源库不断有业务写入时，OMS 会在全量数据迁移启动前，启动增量拉取模块，以拉取源实例中的增量更新数据，对其进行解析、封装，并存储至 OMS 中。 <br>当全量数据迁移完成后，OMS 会启动增量数据回放模块，从增量数据拉取模块中获取增量数据。增量数据经过过滤、映射和转换后，再同步至目标实例中。                                                                                    |
| 全量校验     | 在全量数据迁移完成，增量数据迁移至目标端并与源端基本追平后，OMS 会自动发起一轮针对源库配置的数据表和目标表的全量数据校验任务。 增量数据同步过程中，您也可以发起自定义的数据校检。对于校验结果不一致的数据，您可以重新校验表中的全部数据或仅重新校验表中不一致的数据。       |
| 正向切换     | 正向切换（传统意义上的系统割接流程的抽象化、标准化）不会操作业务应用连接的切换，是 OMS 的数据迁移项目配合应用切换需要执行的任务流。您需要保证在应用连接切换至目标端前完成正向切换的全部流程。<br>正向切换是选择数据迁移便会编排进来的一个流程，您需要终止正向增量同步，删除迁移依赖的附加列和唯一索引，补充在同步过程中被 OMS 过滤掉 Check 约束，并激活目标端 Trigger/FK（迁移前该类对象需要被禁用，否则将引起数据不一致）等，保证新迁移出来的数据库完整、可用。<br>如果您配置了反向增量，切换会多编排进来启动反向增量以及禁用源端 Trigger/FK 的子任务，启动从目标端到源端的实时增量同步，保障业务数据回流至原源端数据库，提供随时切换应用的可能性。 |
| 反向增量     | 迁移完成后，针对于业务割接场景，可以引导用户在业务数据库完成切换前在 OMS 上启动目标库至源库（即反向）的增量同步项目，实时回流业务切换后在目标端数据库产生的变更数据至源业务数据库。|

## 迁移流程

您可以参考以下流程进行迁移前的准备工作、以及创建、管理数据迁移任务：

1. 完成准备工作。

   使用 OMS 迁移数据前，您需要对源或目标数据库进行创建迁移用户、为用户授权等准备工作。详细信息请参见 [创建数据库用户](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091344) 和 [用户权限说明](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091341)。

2. 添加数据源。

   在 OMS 控制台，分别添加源端数据库和目标端数据库为数据源。新建数据源的详细信息，请参见：
   * [新建 OceanBase 物理数据源](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091584)
   * [新建 MySQL 数据源](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091474)
   * [新建 Oracle 数据源](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091476)
   * [新建 TiDB 数据源](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091470)
   * [新建 Kafka 数据源](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091468)
   * [新建 RocketMQ 数据源](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091471)
   * [新建 DataHub 数据源](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091473)
   * [新建 DB2 LUW 数据源](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091469)
   * [新建 PostgreSQL 数据源](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091472)

3. 创建数据迁移任务。

   在迁移项目中指定源端、目标端、迁移类型和需要迁移的表。数据迁移任务包括以下流程：

   1. 数据迁移

      您无需处理中间任务，或进行启动、暂停和中断等操作，OMS 可以自动完成数据迁移的全部流程。

   2. 数据校验

      数据迁移完成后，您可以进行数据校验，验证数据的完整性和正确性。

   3. 同步链路切换

      在业务应用至目标端之前，您可以进行同步链路切换操作，以创建目标端至源端的同步链路。

4. 切换业务至源端数据库。

   请在执行业务前创建回退方案，以降低数据迁移对业务的影响。

5. （可选）查看数据迁移任务的状态。

   您可以在迁移任务的监控页面查看链路详情，实时监控迁移任务的运行状态。详细信息请参见 [查看数据迁移项目的详情](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091492)。

6. （可选）停止并释放数据迁移任务。

   确认迁移任务成功，并不再需要同步源库和目标库的数据后，您可以清理当前的迁移任务。详细信息请参见 [释放和删除数据迁移项目](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091493)。

## 支持的项目类型

OMS 为您提供在线迁移数据和实时同步增量数据的功能，支持的项目类型如下：

* [迁移 MySQL 数据库的数据至 OceanBase 数据库 MySQL 租户](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091373)

* [迁移 OceanBase 数据库 MySQL 租户的数据至 MySQL 数据库](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091364)

* [迁移 Oracle 数据库的数据至 OceanBase 数据库 MySQL 租户](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091377)

* [迁移 OceanBase 数据库 Oracle 租户的数据至 Oracle 数据库](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091379)

* [迁移 Oracle 数据库的数据至 OceanBase 数据库 Oracle 租户](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091363)

* [迁移 DB2 LUW 数据库的数据至 OceanBase 数据库 Oracle 租户](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091362)

* [迁移 OceanBase 数据库 Oracle 租户的数据至 DB2 LUW 数据库](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091372)

* [迁移 DB2 LUW 数据库的数据至 OceanBase 数据库 MySQL 租户](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091375)
  
* [迁移 OceanBase 数据库 MySQL 租户的数据至 DB2 LUW 数据库](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091368)

* [OceanBase 数据库的单向数据迁移](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091365)

* [OceanBase 数据库的容灾双活数据迁移](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091376)

* [迁移 TiDB 数据库的数据至 OceanBase 数据库 MySQL 租户](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091374)

* [迁移 PostgreSQL 数据库的数据至 OceanBase 数据库 MySQL 租户](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091367)

* [迁移 OceanBase 数据库 Oracle 租户的增量数据至 MySQL 数据库](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091366)

## 相关文档

* 更多关于 OMS 的介绍和使用信息，请参见 [OceanBase 迁移服务](https://www.oceanbase.com/docs/oms-doc-cn)。
* 更多关于 OMS 数据迁移的信息，请参见 [数据迁移概述](https://www.oceanbase.com/docs/enterprise-oms-doc-cn-1000000000091371)。
