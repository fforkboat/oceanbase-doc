# 通过修改 UNIT_NUM

对租户内资源的扩容和缩容还可以通过修改资源池中的 `UNIT_NUM` 来实现。

## 前提条件

在进行租户的扩容和缩容操作前，需要进行以下操作：

* 由于空闲的资源池会被计算为占用的资源，故在扩容前，如果有租户被删除，建议与租户对应的资源池也一并删除，以便释放资源。

  删除资源池的相关操作请参见 [删除资源池](../../3.manage-resources/5.manage-resource-pools/6.delete-a-resource-pool.md)。
  
* 进行租户缩容前，建议进行一轮转储以便释放租户正在使用的内存。

  手动触发转储的相关操作请参见 [手动触发转储](../../5.manage-data-storage/1.minor-compaction-management/3.manually-trigger-a-minor-compaction.md)。
  
* 查看集群中资源的分配情况，了解集群中资源的使用情况。

  查看集群节点的资源总量和分配状态的相关操作请参见 [查看集群的资源信息](../../../2.basic-database-management/1.manage-clusters/10.view-cluster-resources.md)。
  
## 通过 SQL 语句修改租户的 UNIT_NUM

您可以通过调大或调小租户的 `UNIT_NUM` 来进行租户的扩容或缩容。

### 背景信息

假设当前集群中共包含 3 个可用区 `z1`、`z2`、`z3`，每个 Zone 内包含 3 台 OBServer。集群中有一个普通租户 `tenant1`，其资源分配情况如下：

```sql
obclient> CREATE RESOURCE UNIT unit1 MAX_CPU 6,MIN_CPU 6, MAX_MEMORY '36G', MIN_MEMORY '36G', MAX_IOPS 128, MIN_IOPS 128, MAX_DISK_SIZE '2T', MAX_SESSION_NUM 64;

obclient> CREATE RESOURCE POOL pool1 UNIT 'unit1', UNIT_NUM 2, ZONE_LIST ('z1','z2','z3');

obclient>CREATE TENANT tenant1 resource_pool_list=('pool1');
```

### 调大 UNIT_NUM

随着业务量的不断变大，每个 Zone 上 2 个资源单元已经无法承载当前的业务量，因此需要考虑调大 `UNIT_NUM` 来提高租户的服务能力，以满足新的业务需求。

1. 使用 `root` 用户登录到数据库的 `sys` 租户。

2. 进入 `oceanbase` 数据库。

   ```sql
   obclient>USE oceanbase;
   ```

3. 查询 `oceanbase.gv$unit` 视图，获取当前租户中的资源配置信息。

   ```sql
   obclient> SELECT * FROM oceanbase.gv$unit;
   ```

   更多 `gv$unit` 视图的字段及说明信息请参见 [gv$unit](../../../../12.reference-guide/1.system-views/2.performance-views/43.gv-unit.md)。

4. 执行以下语句，调大 `UNIT_NUM` 的数量。

   >**说明**
   >
   >不支持通过指定 `unit_id` 的方式调大 `UNIT_NUM` 的数量。

   ```sql
   obclient>ALTER RESOURCE POOL pool1 UNIT_NUM = 3;
   ```

   语句执行后，系统会直接在每个 Zone 内添加一个 Unit。

### 调小 UNIT_NUM

调小 `UNIT_NUM` 实际就是删除资源单元，由于被删除的资源单元上可能存在对应租户的数据，因此，在执行删除资源单元的语句成功返回后，系统还需要将租户数据从被删除的资源单元上迁移出去。具体表现为，OceanBase 数据库会将本次删除资源单元的操作记录到 `__all_rootservice_job` 内部表中，查询该表可以观察本次资源单元的删除进度。

`UNIT_NUM` 被调小后，即将被删除的资源单元会被标记为 `DELETING` 状态，可以通过查询 `__all_unit` 表的 `status` 列来获取资源单元的状态。当租户数据从被删除资源单元全部迁移后，OceanBase 数据库会更新 `__all_rootservice_job` 表，标记本次删除资源单元的任务完成，同时清理 `__all_unit` 表，将处于 `DELETING` 状态的资源单元删除。

具体操作如下：

1. 使用 `root` 用户登录到数据库的 `sys` 租户。

2. 进入 `oceanbase` 数据库。

   ```sql
   obclient>USE oceanbase;
   ```

3. 查询 `oceanbase.gv$unit` 视图，获取当前租户中的资源配置信息。

   ```sql
   obclient> SELECT * FROM oceanbase.gv$unit;
   ```

4. 执行以下语句，调小 `UNIT_NUM` 的数量。

   * 通过不指定 `unit_id` 的方式调小 `UNIT_NUM` 的数量

     ```sql
     obclient>ALTER RESOURCE POOL pool1 UNIT_NUM = 1;
     ```

     语句执行后，系统会自动在每个 Zone 内选取 1 个资源单元进行删除。

   * 通过指定 `unit_id` 调小 `UNIT_NUM` 的数量

     其中，`1001`、`1003` 、`1005` 表示待调小的 Unit 的 `unit_id`。

     ```sql
     obclient> ALTER RESOURCE POOL pool1 UNIT_NUM 1 DELETE UNIT = (1001, 1003,1005);
     ```

     语句执行后，系统会直接删除指定的资源单元。

## 通过 OCP 修改租户资源池中的 Unit 数量

您也可以在 OCP 上修改租户所使用的资源池中的 `UNIT_NUM` 即 Unit 数量来完成租户资源的扩容和缩容。

1. 登录 OCP。

2. 在左侧导航栏上，单击 **租户** 。

3. 在 **租户列表** 中，找到待查看的租户，单击租户名。

4. 在 **总览** 页面的 **副本详情** 区域，找到待修改资源配置的 Zone，在对应的 **操作** 列中，单击 **编辑** 。

5. 在 **Unit 数量** 对应的列中，调大或调小 Unit 的个数。

6. 完成后，单击 **确定** 。

## 更多信息

在租户的扩容和缩容操作中，您可以借助以下内部表或视图来获取租户资源相关的信息：

* 内部表 `oceanbase.__all_unit_config`

  内部表 `oceanbase.__all_unit_config` 记录了当前集群中的所有 unit_config 信息。

* 视图 `gv$unit`

  `gv$unit` 视图中记录了集群中所有租户的资源分配情况。

* 内部表 `oceanbase.__all_resource_pool`

  内部表 `oceanbase.__all_resource_pool` 中记录了当前集群中所有资源池的资源配置情况。其中，`unit_count` 表示资源池中某个资源单元的个数。
