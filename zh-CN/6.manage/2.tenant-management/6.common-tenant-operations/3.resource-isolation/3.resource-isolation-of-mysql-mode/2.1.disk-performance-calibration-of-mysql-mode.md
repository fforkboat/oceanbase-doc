# 磁盘性能校准

在控制 IOPS 资源隔离前，需要进行磁盘性能校准。如果您不需要控制 IOPS 资源隔离，请跳过此步骤。

OceanBase 数据库的磁盘性能校准功能用于对 OBServer 节点所在磁盘的读写性能进行校准。OceanBase 数据库当前支持通过以下两种方式进行磁盘的性能校准：

* 自动校准：通过 `JOB` 语句触发后台任务自动校准。

* 手动校准：通过主动刷新磁盘校准信息手动校准。

## 自动校准

如果当前 OceanBase 集群为空负载，且磁盘有较多空闲空间，您可以通过 `JOB` 语句触发后台任务的方式自动对磁盘性能进行校准。该方式下，系统默认会对数据盘和日志盘各执行一次磁盘校准任务。如果数据盘与日志盘部署在一块物理磁盘上，则系统仅执行一次磁盘性能校准任务。

1. 使用 `root` 用户登录到集群的 `sys` 租户。

   连接示例如下，连接数据库时请以实际环境为准。

   ```shell
   obclient -h10.xx.xx.xx -P2883 -uroot@sys -p***** -A
   ```

   有关更加详细的连接数据库的操作指引，请参见 [连接数据库概述（Oracle 模式）](../../../../../3.develop/1.connect-to-oceanbase-database/1.connect-to-oceanbase-database-of-mysql-mode/1.connection-methods-overview-of-mysql-mode.md)。

2. 根据业务使用场景，选择合适的命令，触发磁盘校准任务。

   * 对集群内的所有 OBServer 节点触发磁盘校准任务

     ```sql
     ALTER SYSTEM RUN JOB job_name;
     ```

     其中，`job_name` 为指定的后台任务名称。磁盘校准任务对应的后台任务名称为 `io_calibration`。

   * 对指定 Zone 内的所有 OBServer 节点触发磁盘校准任务

     语句如下：

     ```sql
     ALTER SYSTEM RUN JOB job_name ZONE [=] zone_name;
     ```

     相关参数说明如下：

     * `job_name`：指定的后台任务名称。磁盘校准任务对应的后台任务名称为 `io_calibration`。
     * `zone_name`：指定待触发磁盘校准任务的 Zone。当前仅支持指定一个 Zone。

     示例：

     ```sql
     ALTER SYSTEM RUN JOB "io_calibration" ZONE = zone1;
     ```

   * 对指定的某个 OBServer 节点触发磁盘校准任务

     语句如下：

     ```sql
     ALTER SYSTEM RUN JOB job_name SERVER [=] 'svr_ip:svr_port';
     ```

     相关参数说明如下：

     * `job_name`：指定的后台任务名称。磁盘校准任务对应的后台任务名称为 `io_calibration`。
     * `svr_ip`：指定待触发磁盘校准任务的 OBServer 节点的 IP。当前仅支持指定一个 OBServer 节点。
     * `svr_port`：指定待触发磁盘校准任务的 OBServer 节点的 RPC 端口。

     示例：

     ```sql
     ALTER SYSTEM RUN JOB "io_calibration" SERVER = 'xx.xx.xx.1:2882';
     ```

3. 查看磁盘 IO 校准状态。

   ```sql
   SELECT * FROM oceanbase.V$IO_CALIBRATION_STATUS;
   ```

4. 确认磁盘 IO 校准是否生效。

   待磁盘性能校准任务执行完成后，您可以通过 GV$IO_BENCHMARK 或 V$IO_BENCHMARK 视图确认磁盘 IO 校准是否生效。

   ```sql
   SELECT * FROM oceanbase.GV$IO_BENCHMARK;
   ```

## 手动校准

如果当前 OceanBase 集群有负载，您可以通过主动刷新磁盘校准信息的方式手动对磁盘性能进行校准。

<main id="notice" type='explain'>
<h4>说明</h4>
<p>如果当前没有相关磁盘的压测数据，您可以使用 FIO 工具执行一次性能压测来获取当前磁盘的性能数据，有关 FIO 工具的详细介绍及使用，请参见 <a href="https://fio.readthedocs.io/en/latest/index.html">FIO 工具官网</a>。</p>
</main>

1. 使用 `root` 用户登录到集群的 `sys` 租户。

   连接示例如下，连接数据库时请以实际环境为准。

   ```shell
   obclient -h10.xx.xx.xx -P2883 -uroot@sys -p***** -A
   ```

   有关更加详细的连接数据库的操作指引，请参见 [连接数据库概述（Oracle 模式）](../../../../../3.develop/1.connect-to-oceanbase-database/1.connect-to-oceanbase-database-of-mysql-mode/1.connection-methods-overview-of-mysql-mode.md)。

2. 根据业务使用场景，选择合适的命令，主动刷新磁盘校准信息。

   * 对集群内的所有 OBServer 节点刷新一次磁盘性能信息

     ```sql
     ALTER SYSTEM REFRESH IO CALIBRATION [STORAGE [=] 'storage_name'] [CALIBRATION_INFO [=] ("mode : size : latency : iops [, mode : size : latency : iops]") ];
     ```

     相关参数说明如下：

     * `STORAGE`：指定 OceanBase 数据库存储盘的名称：

       * `DATA`：数据盘。如果不指定 `STORAGE` 参数，默认为 `DATA`。
       * `REDO`：日志盘。

     * `CALIBRATION_INFO`：指定待刷新的磁盘校准信息。如果不指定，则默认从内部表刷新磁盘性能信息。

       * `mode`：指定读还是写性能，支持 `r`、 `w`、`read` 或 `write`。
       * `size`：指定数据量，默认为字节，即如果指定的值为纯数字，则其单位默认为字节。同时支持指定带单位的数值，包括 K、KB、M、MB、G、GB。
       * `latency`：指定 RT（Response Time）的值，默认单位为微秒，即如果指定的值为纯数字，则其单位默认为微秒。同时支持指定带单位的数值，包括 us、ms、s、min、h。
       * `iops`：指定 IOPS 的值，单位为 1。

     对集群内所有 OBServer 节点的数据盘从内部表刷新一次磁盘性能信息的示例如下：

     ```sql
     ALTER SYSTEM REFRESH IO CALIBRATION;
     ```

   * 清除集群内所有 OBServer 节点的磁盘性能信息

     ```sql
     ALTER SYSTEM REFRESH IO CALIBRATION [STORAGE [=] 'storage_name'] CALIBRATION_INFO = ();
     ```

     其中，`STORAGE` 用于指定 OceanBase 数据库存储盘的名称：

     * `DATA`：数据盘。如果不指定 `STORAGE` 参数，默认为 `DATA`。
     * `REDO`：日志盘。

     清除集群内所有 OBServer 节点数据盘的磁盘性能信息的示例如下：

     ```sql
     ALTER SYSTEM REFRESH IO CALIBRATION CALIBRATION_INFO = ();
     ```

   * 对指定 Zone 内的所有 OBServer 节点刷新一次磁盘校准信息

     语句如下：

     ```sql
     ALTER SYSTEM REFRESH IO CALIBRATION [STORAGE [=] 'storage_name'] [CALIBRATION_INFO [=] ("mode : size : latency : iops [, mode : size : latency : iops]") ] ZONE [=] zone_name;
     ```

     相关参数说明如下：

     * `STORAGE`：指定 OceanBase 数据库存储盘的名称：

       * `DATA`：数据盘。如果不指定 `STORAGE` 参数，默认为 `DATA`。
       * `REDO`：日志盘。

     * `CALIBRATION_INFO`：指定待刷新的磁盘校准信息。如果不指定，则默认从内部表刷新磁盘性能信息。

       * `mode`：指定读还是写性能，支持 `r`、 `w`、`read` 或 `write`。
       * `size`：指定数据量，默认为字节，即如果指定的值为纯数字，则其单位默认为字节。同时支持指定带单位的数值，包括 K、KB、M、MB、G、GB。
       * `latency`：指定 RT（Response Time）的值，默认单位为微秒，即如果指定的值为纯数字，则其单位默认为微秒。同时支持指定带单位的数值，包括 us、ms、s、min、h。
       * `iops`：指定 IOPS 的值，单位为 1。

     * `zone_name`：指定待刷新磁盘校准信息的 Zone。当前仅支持指定一个 Zone。

     对 `zone1` 内的所有 OBServer 节点的数据盘刷新一次磁盘校准信息的示例如下：

     ```sql
     ALTER SYSTEM REFRESH IO CALIBRATION STORAGE = DATA CALIBRATION_INFO = ("read:4K:100us:200000","write:2M:5ms:1500") ZONE = zone1;
     ```

     本示例中，刷新的磁盘校准信息为：4KB 数据随机读的 RT 为 100 微秒，IOPS 为 200000，2MB 数据随机写的 RT 为 5 毫秒，IOPS 为 1500。

   * 对指定的 OBServer 节点刷新一次磁盘校准信息

     语句如下：

     ```sql
     ALTER SYSTEM REFRESH IO CALIBRATION [STORAGE [=] 'storage_name'] [CALIBRATION_INFO [=] ("mode : size : latency : iops [, mode : size : latency : iops]") ] SERVER [=] 'svr_ip:svr_port';
     ```

     相关参数说明如下：

     * `STORAGE`：指定 OceanBase 数据库存储盘的名称：

       * `DATA`：数据盘。如果不指定 `STORAGE` 参数，默认为 `DATA`。
       * `REDO`：日志盘。

     * `CALIBRATION_INFO`：指定待刷新的磁盘校准信息。如果不指定，则默认从内部表刷新磁盘性能信息。

       * `mode`：指定读还是写性能，支持 `r`、 `w`、`read` 或 `write`。
       * `size`：指定数据量，默认为字节，即如果指定的值为纯数字，则其单位默认为字节。同时支持指定带单位的数值，包括 K、KB、M、MB、G、GB。
       * `latency`：指定 RT（Response Time）的值，默认单位为微秒，即如果指定的值为纯数字，则其单位默认为微秒。同时支持指定带单位的数值，包括 us、ms、s、min、h。
       * `iops`：指定 IOPS 的值，单位为 1。

     * `svr_ip`：指定待刷新磁盘校准信息的 OBServer 节点的 IP。
     * `svr_port`：指定待刷新磁盘校准信息的 OBServer 节点的 RPC 端口。

     对指定的 OBServer 节点刷新一次磁盘校准信息的示例如下：

     ```sql
     ALTER SYSTEM REFRESH IO CALIBRATION STORAGE = DATA CALIBRATION_INFO = ("read:4K:100us:200000","write:2M:5ms:1500") SERVER = 'xx.xx.xx.1:2882';
     ```

3. 查看磁盘 IO 校准状态。

   ```sql
   SELECT * FROM oceanbase.V$IO_CALIBRATION_STATUS;
   ```

4. 确认磁盘 IO 校准是否生效。

   待磁盘性能校准任务执行完成后，您可以通过 GV$IO_BENCHMARK 或 V$IO_BENCHMARK 视图确认磁盘 IO 校准是否生效。

   ```sql
   SELECT * FROM oceanbase.GV$IO_BENCHMARK;
   ```
