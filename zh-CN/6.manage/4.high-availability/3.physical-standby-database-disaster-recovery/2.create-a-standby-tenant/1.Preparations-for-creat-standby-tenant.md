# 创建备租户前准备

创建租户前，需要选择备租户的源端，明确待创建的备租户个数，选择备租户的创建方式并进行备租户的资源准备。

## 选择备租户的源端

备租户既可以从主租户同步日志，也可以从另外一个备租户同步日志，从另一个备租户同步日志的部署架构，称为级联备库或级联备租户。

您可以根据业务实际情况来选择备租户的源端。

## 选择待创建的备租户个数

OceanBase 数据库当前版本对一个主租户（或备租户）可以同步的备租户的个数无限制。

对于基于日志归档的物理备库场景，由于日志的同步依赖存储介质，需要根据实际的业务需求情况，来确定创建多少个租户。

对于基于网络的物理备库场景，由于备租户在同步日志时，需要读取源端租户的日志，会消耗源端租户的 CPU、内存和 IO 资源，同时还会消耗备租户与源端租户之间的网络带宽资源。因此，在创建备租户时，需要结合源端租户的资源使用情况及实际的业务需求情况，来确定创建多少个备租户。

## 选择创建备租户的方式

OceanBase 数据库提供了三种方式创建备租户，您可以根据实际的业务场景，选择合适的方式创建备租户。

* 创建空备租户

  若主租户为刚刚新创建的主租户，或者用户可以确认主租户所在集群或日志归档介质上保存有该主租户自创建后完整的日志，则其备租户在创建时不需要依赖除日志外的其他基线或转储数据。此时，可以通过 `CREATE STANDBY TENANT` 语句创建备租户。

  检查主租户是否拥有完整日志的方法如下：

  1. 使用 `root` 用户登录主租户所在集群的 `sys` 租户。

  2. 执行以下命令，获取主租户的 `TENANT_ID`。

     * 主租户所在集群的 `sys` 租户查询主租户的 `TENANT_ID`

       ```sql
       SELECT TENANT_ID FROM oceanbase.DBA_OB_TENANTS WHERE TENANT_NAME = 'mysql001';
       ```

     * 主租户查询

       MySQL 模式

       ```sql
       SELECT TENANT_ID FROM oceanbase.DBA_OB_TENANTS WHERE TENANT_NAME = 'mysql001';
       ```

       Oracle 模式：

       ```sql
       SELECT TENANT_ID FROM SYS.DBA_OB_TENANTS WHERE TENANT_NAME = 'oracle001';
       ```

     查询结果的示例如下：

     ```shell
     +-----------+
     | TENANT_ID |
     +-----------+
     |      1002 |
     +-----------+
     1 rows in set
     ```

  3. 执行以下命令，查看主租户上的日志流信息。

     * MySQL 模式

       ```sql
       SELECT TENANT_ID,LS_ID, BEGIN_LSN FROM oceanbase.GV$OB_LOG_STAT WHERE TENANT_ID = 1002 AND ROLE = 'LEADER' ;
       ```

     * Oracle 模式

       ```sql
       SELECT TENANT_ID,LS_ID, BEGIN_LSN FROM SYS.GV$OB_LOG_STAT WHERE TENANT_ID = 1002 AND ROLE = 'LEADER' ;
       ```

     查询结果的示例如下：

     ```shell
     +-----------+-------+-----------+
     | TENANT_ID | LS_ID | BEGIN_LSN |
     +-----------+-------+-----------+
     |      1002 |     1 |         0 |
     |      1002 |  1001 |         0 |
     +-----------+-------+-----------+
     2 rows in set
     ```

     其中，`BEGIN_LSN` 表示当前日志流副本保存的最早的日志 LSN（Log Sequence Number），如果 `BEGIN_LSN` 的值为 `0`，则表示当前日志流副本拥有自创建以来完整的日志。

     根据查询结果，日志流副本所对应的 `BEGIN_LSN` 的值为 `0`，表示当前日志流副本拥有自创建以来完整的日志；如果该租户的所有日志流副本对应的 `BEGIN_LSN` 的值均为 `0`，则表示该租户的所有日志流均拥有完整日志，可以通过 `CREATE STANDBY TENANT` 语句创建空备租户。

* 使用物理备份恢复功能创建备租户

  该方式为创建备租户的通用方式，任何场景下均适用。有关物理备份恢复的详细介绍及操作，请参见 [物理备份恢复概述](../../6.backup-and-recovery/1.overview-of-physical-backup-and-recovery.md)。

* 使用 BACKUP DATABASE PLUS ARCHIVELOG 功能创建备租户

  由于使用常规的物理备份恢复功能创建备租户时，要求使用共享存储（例如，OSS、NFS 等）来保存数据备份和日志归档，同时要求主租户和备租户所在的集群可以同时访问共享存储。这对于社区版用户或单机版用户很不友好，有较高的使用门槛。

  基于上述原因，您可以使用 BACKUP DATABASE PLUS ARCHIVELOG 功能，将主租户的所有数据和归档日志在本机（对应主租户为单机的使用场景）或共享存储（对应社区版且主租户为集群的使用场景）上生成一份数据库的快照，该快照中包含了基线数据和数据库运行必需的归档日志，再将该快照上传到待创建的备租户所在集群可以访问的介质上，最后使用数据库快照恢复出一个备租户。

## 备租户的资源准备

创建备租户前，需要为备租户分配资源池，规划备租户所使用的 CPU、Memory、日志盘空间及 IOPS 等资源，并确定备租户的副本数、Primary Zone 以及 Locality 等信息。

备租户所使用的租户资源不要求和主租户完全一致。在使用上，建议结合业务的实际情况和主备租户所承载的业务压力，为备租户选择合适的资源规格。

