# RPC 连接认证

## 升级

本方案支持灰度升级流程（分段平滑升级不影响业务进程），升级过程中，高版本与低版本的 OBServer 是相互兼容的。
即高版本作为客户端能连入低版本服务端；同时低版本作为客户端也能连入高版本服务端。升级后，默认不开启 RPC 认证，需要手动开启。

## 开启基于 SSL 握手的 RPC 认证

1. 需要在安装目录下创建 wallet 文件夹并将证书和私钥文件放入该文件夹。证书和私钥文件包括根证书（ca.pem）、证书（server-cert.pem）、私钥（server-key.pem）三个文件。

   <main id="notice" type='explain'>
     <h4>说明</h4>
     <ul>
     <li>默认安装目录路径：/home/admin/oceanbase。</li>
     <li>wallet 文件夹及文件夹下的文件名不能更改。</li>
     <li>若拥有多台服务器，则每台服务器的安装目录下都需创建 wallet 文件夹，并在该文件夹中放入证书和私钥。</li>
     <li>请确保所需的证书文件就绪后再开启认证，否则，会导致认证失败，进而服务不可用。</li>
     </ul>
   </main>

1. 登录 OceanBase 数据库，依次执行如下命令。

   ```sql
   --加载 RPC 认证相关的 SSL 配置。
   ALTER SYSTEM SET ssl_client_authentication=True;

   --将客户端的认证方式设置为 SSL_NO_ENCRYPT。
   ALTER SYSTEM SET rpc_client_authentication_method = 'SSL_NO_ENCRYPT';

   --[可选]服务端禁用 NONE。注意，服务端默认同时支持 NONE和 SSL_NO_ENCRYPT两种认证方式。
   --对于安全要求比较高的场景，建议在服务端禁掉 NONE。
   ALTER SYSTEM SET rpc_server_authentication_method = 'SSL_NO_ENCRYPT';
   ```

## 注意事项

* 如果后续需要更改认证方式，只需重新修改设置。
* 开启认证后，只对新建的 RPC 连接起作用，已有的连接不受影响。若想要对已连接的客户端进行认证，需要分批重启 OBServer。
