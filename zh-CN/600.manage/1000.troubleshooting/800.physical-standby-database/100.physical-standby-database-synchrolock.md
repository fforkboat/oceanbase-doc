# 物理备库同步过程中卡住

本文主要介绍物理备库在同步过程中出现日志同步卡住时问题的排查及定位方法。

## 常见问题现象及原因

### 问题一

**问题现象**

用户通过物理恢复的方式恢复出备租户后，未执行 `RECOVER` 命令更改新备租户的恢复终点，并且日志流已经恢复到指定的终点，备租户的日志同步卡住。

**问题原因**

通常情况下，通过物理恢复的方式恢复出备租户后，备租户的日志同步就会停留在指定的恢复终点，例如，用户指定恢复到 2023-08-04 10:00:00。

如下所示示例中，租户 `restore_oracle_tenant` 的租户角色为 `STANDBY`，其同步进度卡在了某个固定时间点。造成该现象的原因是用户未执行 RECOVER 命令，其租户同步位点 `SYNC_SCN` 等于可恢复位点 `RECOVERY_UNTIL_SCN`，故备租户无需再同步更多日志。

```shell
obclient> SELECT TENANT_ID,TENANT_NAME, STATUS, TENANT_ROLE, SWITCHOVER_STATUS, SYNC_SCN, REPLAYABLE_SCN, READABLE_SCN,RECOVERY_UNTIL_SCN FROM SYS.DBA_OB_TENANTS\G
*************************** 1. row ***************************
                    TENANT_ID: 1002
                  TENANT_NAME: restore_oracle_tenant
                  TENANT_ROLE: STANDBY
                       STATUS: NORMAL
            SWITCHOVER_STATUS: NORMAL
                     SYNC_SCN: 1690425747241344851
               REPLAYABLE_SCN: 1690425747241344851
                 READABLE_SCN: 1690425747241344851
           RECOVERY_UNTIL_SCN: 1690425747241344851
1 row in set
```

### 问题二

**问题现象**

备租户由于租户的同步进度导致日志同步卡住，具体表现为，租户的同步位点小于所有日志流的同步位点。

其中，租户的同步位点可通过`DBA_OB_TENANTS` 视图中的 `SYNC_SCN` 获取；所有日志流的同步位点可通过 `V$OB_LS_LOG_RESTORE_STATUS` 视图中的 `SYNC_SCN` 获取。

**问题原因**

备租户在同步日志的过程中，遵循所有日志流齐步走的策略，因此每个日志流均会考虑租户的 `SYNC_SCN`，并且会基于一定的策略超前拉取日志。由于租户的 `SYNC_SCN` 不推进，会导致日志同步也停止，直到租户的 `SYNC_SCN` 恢复后才能重新开始日志同步。

## 排查步骤

### 步骤一：通过 DBA_OB_TENANTS 视图查看租户状态

1. 租户管理员登录问题租户或问题租户所在集群的 `sys` 租户。

2. 根据租户的 `TENANT_ID` 或 `TENANT_NAME` 查询问题租户的基本状态信息，包括租户角色、同步位点等信息。

   * 系统租户查看指定租户的基本状态信息

     ```sql
     SELECT TENANT_ID, TENANT_NAME, TENANT_ROLE, STATUS, SWITCHOVER_STATUS, SYNC_SCN, REPLAYABLE_SCN,READABLE_SCN, RECOVERY_UNTIL_SCN FROM oceanbase.DBA_OB_TENANTS;
     ```

   * 问题租户查询本租户的基本状态信息

     :::tab
     tab  MySQL 模式

     ```sql
     SELECT TENANT_ID, TENANT_NAME, TENANT_ROLE, STATUS, SWITCHOVER_STATUS, SYNC_SCN, REPLAYABLE_SCN,READABLE_SCN, RECOVERY_UNTIL_SCN FROM oceanbase.DBA_OB_TENANTS;
     ```

     tab Oracle 模式

     ```sql
     SELECT TENANT_ID, TENANT_NAME, TENANT_ROLE, STATUS, SWITCHOVER_STATUS, SYNC_SCN, REPLAYABLE_SCN,READABLE_SCN, RECOVERY_UNTIL_SCN FROM SYS.DBA_OB_TENANTS;
     ```

     :::

   查询结果中，重点关注以下几列的值：

   * `TENANT_ROLE`：`STANDBY` 表示备租户；`PRIMARY` 表示主租户。
   * `SYNC_SCN`：表示租户的同步位点。
   * `REPLAYABLE_SCN`：表示租户的可回放位点，SCN 大于该位点的日志不能回放。
   * `RECOVERY_UNTIL_SCN`：表示租户可恢复到的终点，如果值为 `4611686018427387903`，则表示恢复到无穷。

     如果 `RECOVERY_UNTIL_SCN` 为某个指定的值（非 `4611686018427387903`），则当租户的同步位点 `SYNC_SCN` 与租户可恢复到的终点 `RECOVERY_UNTIL_SCN` 相等时，租户不再同步日志。

   有关 `DBA_OB_TENANTS` 视图的更多说明，请参见 [DBA_OB_TENANTS](../../../700.reference/700.system-views/400.system-view-of-mysql-mode/200.dictionary-view-of-mysql-mode/19300.oceanbase-dba_ob_tenants-of-mysql-mode.md)。

### 步骤二：通过 CDB_OB_LOG_RESTORE_SOURCE 或 DBA_OB_LOG_RESTORE_SOURCE 视图查看日志恢复源

V4.x 版本的物理备库主要通过日志恢复源来同步日志，您可以通过 `CDB_OB_LOG_RESTORE_SOURCE` 或 `DBA_OB_LOG_RESTORE_SOURCE` 来确认问题租户是否设置了日志恢复源。

1. 租户管理员登录问题租户或问题租户所在集群的 `sys` 租户。

2. 确认问题租户是否设置了日志恢复源。

   * 系统租户根据步骤一查询出来的 `TENANT_ID`查看指定租户的日志恢复源

     ```sql
     SELECT * FROM oceanbase.CDB_OB_LOG_RESTORE_SOURCE WHERE TENANT_ID=1xxx;
     ```

   * 问题租户查看本租户的日志恢复源

     :::tab
     tab  MySQL 模式

     ```sql
     SELECT * FROM oceanbase.DBA_OB_LOG_RESTORE_SOURCE;
     ```

     tab Oracle 模式

     ```sql
     SELECT * FROM SYS.DBA_OB_LOG_RESTORE_SOURCE;
     ```

     :::

   查询结果中，重点关注以下几列的值：

   * `TYPE`：如果值为 `LOCATION`，则表示当前租户通过归档日志从源端租户同步日志，即属于基于归档的物理备库；如果值为 `SERVICE`，则表示当前租户通过网络从主租户直接同步日志，即属于基于网络的物理备库。

   * `VALUE`：其值与 `TYPE` 的值对应，分别为源端租户的归档目录以及主租户的 Access Point。

     如果值为归档目录，则需要检查归档目录在主、备租户的所有机器上是否均可以访问；如果值为主租户的 Access Point，则需要确认 IP 列表、USER、PASSWORD 等是否均设置正确。

   有关 `CDB_OB_LOG_RESTORE_SOURCE` 和 `DBA_OB_LOG_RESTORE_SOURCE` 视图的更多说明，请参见 [CDB_OB_LOG_RESTORE_SOURCE](../../../700.reference/700.system-views/400.system-view-of-mysql-mode/200.dictionary-view-of-mysql-mode/21700.cdb_ob_log_restore_source-of-mysql-mode.md) 和 [DBA_OB_LOG_RESTORE_SOURCE](../../../700.reference/700.system-views/500.system-view-of-oracle-mode/200.dictionary-view-of-oracle-mode/29100.dba_ob_log_restore_source-of-oracle-mode.md)。

### 步骤三：通过 V$OB_LS_LOG_RESTORE_STATUS 视图查看日志流的恢复状态

1. 租户管理员登录问题租户或问题租户所在集群的 `sys` 租户。

2. 查看问题租户的日志同步状态。

   * 系统租户根据步骤一查询出来的 `TENANT_ID`查看指定租户的恢复状态

     ```sql
     SELECT * FROM oceanbase.V$OB_LS_LOG_RESTORE_STATUS WHERE TENANT_ID=1xxx;
     ```

   * 问题租户查看本租户的日志恢复源

     :::tab
     tab  MySQL 模式

     ```sql
     SELECT * FROM oceanbase.V$OB_LS_LOG_RESTORE_STATUS;
     ```

     tab Oracle 模式

     ```sql
     SELECT * FROM SYS.V$OB_LS_LOG_RESTORE_STATUS;
     ```

     :::

     查询结果中，重点关注 `SYNC_STATUS` 列，该列表示的是日志流的恢复状态，如果值为 `NORMAL` 则表示日志在正常同步中，其他状态则为异常，日志同步状态及其表示的含义如下表所示。

     有关 `V$OB_LS_LOG_RESTORE_STATUS` 视图的更多说明，请参见 [V$OB_LS_LOG_RESTORE_STATUS](../../../700.reference/700.system-views/400.system-view-of-mysql-mode/300.performance-view-of-mysql-mode/14200.v-ob_ls_log_restore_status-of-mysql-mode.md)。

     | 日志同步状态            | 含义                                                                                  |
     |------------------------|--------------------------------------------------------------------------------------|
     | NORMAL                 | 正常同步中                                                                            |
     | SOURCE HAS A GAP       | 备库与日志源端日志有 gap，主租户的日志未同步到备租户就已回收                              |
     | STANDBY LOG NOT MATCH  | 恢复日志与备租户冲突，可能是出现双 PRIMARY 或者日志恢复源设置错误                         |
     | CHECK USER OR PASSWORD | 复制账户用户名或密码不对，无法访问原主租户                                                |
     | CHECK NETWORK          | 主租户不可达，检查网络是否异常                                                           |
     | RESTORE SUSPEND        | 备租户已经恢复到指定位点                                                                |
     | STANDBY NEED UPGRADE   | 备租户的 Binary 版本落后，需要升级                                                        |
     | PRIMARY TENANT DROPPED | 主租户已经被删除                                                                       |
     | FETCH LOG TIMEOUT      | 同步日志超时，需要排查网络健康状况或者调大备租户日志同步超时的租户级配置项 `standby_db_fetch_log_rpc_timeout` ，有关 standby_db_fetch_log_rpc_timeout 的详细说明请参见 [standby_db_fetch_log_rpc_timeout](../../../700.reference/800.configuration-items-and-system-variables/100.system-configuration-items/400.tenant-level-configuration-items/25100.standby_db_fetch_log_rpc_timeout.md)  |
     | STANDBY IN THROTTLING  | 备租户写入限速中                                                                       |
     | STANDBY LOG DISK IS FULL | 备租户磁盘空间不足                                                                   |
     | WAIT LOG STREAM CREATED  | 等待备租户创建日志流完成                                                              |
     | NOT AVAILABLE          | 其他异常导致的日志同步不可用                                                            |
