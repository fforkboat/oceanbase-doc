# 物理恢复失败

本节主要介绍物理恢复失败时问题的排查及定位方法。

物理恢复功能对数据备份和日志归档功能具有强依赖，即发起物理恢复前，需要保证至少存在一个可用的备份集，且日志归档连续。

<main id="notice" type='notice'>
<h4>注意</h4>
<ul>
<li>OceanBase 数据库当前仅支持将低版本的备份数据恢复到同版本或高版本中，但不支持将 V3.x 或 V2.x 版本的备份数据恢复到 V4.x 版本中。</li>
<li>对于 OceanBase 数据库 V4.1.0 版本，不支持恢复 OceanBase 数据库 V4.1.0 之前版本的数据。例如，OceanBase 数据库 V4.0.x 版本的备份数据不能恢复到 OceanBase 数据库 V4.1.0 版本中。</li>
</ul>
</main>

## 问题一：执行恢复命令失败

执行 `ALTER SYSTEM RESTORE` 语句发起物理恢复时，命令执行失败，您可以通过以下步骤进行排查处理。

1. 租户管理员登录集群的 `sys` 租户。

2. 执行以下语句，确认报错的错误码。

   ```sql
   SELECT * FROM oceanbase.DBA_OB_ROOTSERVICE_EVENT_HISTORY WHERE module='physical_restore';
   ```

   查询结果中，重点关注以下信息：

   * `result` 对应的值，即报错的错误码。

   * `RS_SVR_IP` 的值，即 Root Service 所在机器的 IP。

3. 根据上一步获取到的 `RS_SVR_IP`，登录 Root Service 所在的机器，搜索 `rootservice.log` 日志，确认报错点。

   1. 登录 Root Service 所在的机器。

   2. 进入日志所在的目录。

      ```shell
      cd /home/admin/oceanbase/log
      ```

   3. 执行以下命令，搜索日志，找到报错点。

      ```shell
      grep "ob_restore_util" rootservice.log | grep "ret=\-4016"
      ```

      其中，`-4016` 为上一步中 `result` 对应的值。

      <main id="notice" type='notice'>
      <h4>注意</h4>
      <p>如果在 <code>rootservice.log</code> 中 <code>grep</code> 不到相关日志，可能是因为 <code>rootservice.log</code> 切了文件，可以执行 <code>grep "ob_restore_util" rootservice.log.* | grep "ret=\-4016"</code>。</p>
      </main>

      常见命令执行失败的报错信息为 `-4018 no enough log for restore.`。该问题通常是由于用户在执行 `ALTER SYSTEM RESTORE` 语句时所指定的恢复终点不正确导致，需要确认在该恢复终点之前是否存在可用的备份集和日志归档。

      可用的备份集和日志归档的判断方法如下：

      * FILE_STATUS = DELETED, 以及 STATUS = OB_SUCCESS
      * a. restore_scn >= 备份集的 min_restore_scn
        b. restore_scn <= 日志归档的 checkpoint_scn

4. 获取搜索到的日志报错信息后，联系技术支持人员协助处理。

## 租户的恢复状态一直卡在 RESTORE_WAIT_LS 状态

执行 `ALTER SYSTEM RESTORE` 语句发起物理恢复后，查看视图 `CDB_OB_RESTORE_PROGRESS`，发现租户的恢复状态一直卡在 `RESTORE_WAIT_LS` 状态，如下所示。

```shell
*************************** 1. row ***************************
                         TENANT_ID: 1
                            JOB_ID: 1
               RESTORE_TENANT_NAME: restore_oracle
                 RESTORE_TENANT_ID: 1
                BACKUP_TENANT_NAME: backup_tenant
                  BACKUP_TENANT_ID: 1002
               BACKUP_CLUSTER_NAME: backup_cluster
                       BACKUP_DEST: file:///data/nfs/backup//archive,file:///data/nfs/backup/data
                    RESTORE_OPTION: pool_list=small_pool_2&primary_zone=z1
                       RESTORE_SCN: NULL
               RESTORE_SCN_DISPLAY: 
                            STATUS: WAIT_TENANT_RESTORE_FINISH
                   START_TIMESTAMP: 
                   BACKUP_SET_LIST: file:///data/nfs/backup/data/backup_set_1_full
                 BACKUP_PIECE_LIST: file:///data/nfs/backup/archive/2_1_2,file:///data/nfs/backup/archive/2_1_3
                       TOTAL_BYTES: NULL
               TOTAL_BYTES_DISPLAY: NULL
                      FINISH_BYTES: NULL
              FINISH_BYTES_DISPLAY: NULL
                       DESCRIPTION:
*************************** 2. row ***************************
                         TENANT_ID: 1002
                            JOB_ID: 1
               RESTORE_TENANT_NAME: mysql
                 RESTORE_TENANT_ID: 1002
                BACKUP_TENANT_NAME: restore_oracle
                  BACKUP_TENANT_ID: 1002
               BACKUP_CLUSTER_NAME: backup_cluster
                       BACKUP_DEST: file:///data/nfs/backup//archive,file:///data/nfs/backup/data
                    RESTORE_OPTION: pool_list=small_pool_2&primary_zone=z1
                       RESTORE_SCN: 1657262084934108000
               RESTORE_SCN_DISPLAY: 2022-07-08 06:34:44.934108
                            STATUS: RESTOE_WAIT_LS
                   START_TIMESTAMP: 
                   BACKUP_SET_LIST: file:///data/nfs/backup/data/backup_set_1_full
                 BACKUP_PIECE_LIST: file:///data/nfs/backup/archive/2_1_2,file:///data/nfs/backup/archive/2_1_3
                       TOTAL_BYTES: 0
               TOTAL_BYTES_DISPLAY: 0.00MB
                      FINISH_BYTES: 0
              FINISH_BYTES_DISPLAY: 0.00MB
                       DESCRIPTION:
2 rows in set
```

有关视图 `CDB_OB_RESTORE_PROGRESS` 的详细字段说明，请参见 [CDB_OB_RESTORE_PROGRESS](../../../700.reference/500.system-reference/400.system-view-of-mysql-mode/200.dictionary-view-of-mysql-mode/9600.oceanbase-cdb_ob_restore_progress-of-mysql-mode.md)。

根据上述获取到的信息，可以按照以下方法进行排查处理。

1. 租户管理员登录集群的 `sys` 租户。

2. 执行以下语句，确认待恢复的租户其日志流副本的恢复状态。

   ```sql
   SELECT ls_id,svr_ip,svr_port,role,restore_status,zone FROM oceanbase.__all_virtual_ls_meta_table WHERE tenant_id = xxx;
   ```

   例如，查询示例如下：

   ```shell
   +-------+----------------+----------+------+----------------+------+
   | ls_id | svr_ip         | svr_port | role | restore_status | zone |
   +-------+----------------+----------+------+----------------+------+
   |     1 | 100.xx.xx.xx   |     5003 |    1 |              0 | z1   |
   |  1001 | 100.xx.xx.xx   |     5003 |    1 |              0 | z1   |
   |  1002 | 100.xx.xx.xx   |     5003 |    1 |              6 | z1   |
   +-------+----------------+----------+------+----------------+------+
   3 rows in set
   ```

   查询结果中，主要关注以下几列信息：

   * `role`：副本角色。`1` 表示 Leader 副本，负责从外部介质恢复数据；`2` 表示 Follower 副本，负责从 Leader 副本拉取恢复数据。
   * `restore_status`：日志流副本的恢复状态：

     * 0：恢复正常完成
     * 1：恢复开始
     * 2：恢复 sys tablet 和创建 user tablet
     * 3：等待 sys tablet 恢复完成
     * 4：恢复 user tablet meta
     * 5：等待恢复 user tablet 完成
     * 6：restore major sst meta, minor sst and replay clog
     * 7：等待 Followers 副本快速恢复
     * 8：finish quick restore, major macro blocks are in remote reference state
     * 9：restore major macro blocks
     * 10：wait followers to restore major macro blocks
     * 11：恢复失败

   根据查询结果：

   * 如果所有日志流的进度均长时间卡住不推荐，则大概率可以判断是恢复线程卡住，您可以执行步骤 3，进一步排查确认。
   * 如果日志流副本 `restore_status` 的值为 `6` 或者 `8`，您可以执行步骤 4，进一步排查确认。
   * 如果日志流副本 `restore_status` 的值为 `13`，则表示日志流恢复失败，但未汇报给 Root Service，您可以执行步骤 5 进一步排查确认。
   * 如果日志流副本 `restore_status` 的值为除了 `6`、`8`、`13` 以外的其他状态，您可以执行步骤 6 进一步排查确认。

3. 排查是否是 HA_service 线程卡住。

   可以通过 obstack 工具来排查线程卡住问题。

   如果对应租户的 HA_service 堆栈信息显示如下所示信息，则确定为恢复线程卡住，在等待 ls_lock。

4. 排查是否是日志流拉取或回放的问题。

   如果日志流的恢复状态 `restore_status` 值为 `6`，则处于该状态的日志流主要负责从归档目录中完成日志的拉取（包括提交到 palf）及回放。

   1. 根据上一步查询到的机器信息，登录到日志流副本所在的机器。

   2. 进入日志所在的目录。

      ```shell
      cd /home/admin/oceanbase/log
      ```

   3. 执行以下命令，搜索日志，确认报错点。

      ```shell
      grep "clog replay not finish, wait later" observer.log |  grep "\[Ttenant_id\]"
      ```

      其中，`tenant_id` 需要替换为恢复租户的 ID。

      如果搜索结果中有大量以下日志打印，则表示问题与日志回放模块有关，需要确认未回放完成的日志流的 id。

      ```java script
      observer.log.20220708143857:[2022-07-08 14:38:47.875794] INFO  [STORAGE] leader_quick_restore_ (ob_ls_restore_handler.cpp:1555) [102036][T1002_HAService][T1002][Y138B644564E0-0005E3456E184173-0-0] [lt=5] clog replay not finish, wait later(*ls_={ls_meta:{tenant_id:1002,ls_id{id:1}，replica_type:0, ls_create_status:1, clog_checkpoint_ts:1657261946958110451,clog_base_lsn:{val1:0}, rebuild_sq:0, migration_status:0, gc_state_:1, offline_ts_ns_:-1, restore_status:{status:6}, replayable_point:0, tablet_change_checkpoint_ts:0}, log_handler:{role:2,proposal_id:9223372036854775807, palf_env+:0x7fd8807fe030, is_inited_:true}, restore_handler:{is_inited:true, id:1, proposal_id:1, role:1, parent:NULL, context:{issued:false, last_fetch_ts:-1, max_submit_lsn:{val1:18446744073709551615}, max_fetch_lsn:{val1:18446744073709551615}}} is_inited:true, tablet_gc_handler:{tablet_persist_trigger:0, is_inited:true}})
      ```

   4. 找到 `restore_status` 值为 `6` 的日志流的 Leader。

      ```sql
      SELECT * FROM oceanbase.__all_virtual_log_stat WHERE tenant_id = xxxxx AND ls_id = yyyy;
      ```

   5. 根据查询到的日志流 Leader，查看日志是否从归档恢复到目标租户。

       比较内部表 `__all_virtual_log_stat` 中 `end_scn` 的值与内部表 `__all_virtual_tenant_info` 中 `recovery_until_scn` 的值，检查日志是否恢复到租户。其中，`recovery_until_scn` 为租户恢复终点。

      ```sql
      SELECT count(1) FROM oceanbase.__all_virtual_log_stat WHERE tenant_id = 1002 AND end_scn < (SELECT recovery_until_scn FROM oceanbase.__all_virtual_tenant_info WHERE tenant_id = 1002);
      ```

   6. 确认日志是否回放完成。

   7. 如果确认日志恢复完成，即日志拉取和日志回放均完成，但 `restore_status` 值为仍为 `6`，可以确认一下状态机推进线程是否在工作以及是否有报错。

5. 排查是否是日志流恢复失败但未恢复给 Root Service。

6.

## schema 刷新问题

## 视图中恢复任务的状态为 FAILED
