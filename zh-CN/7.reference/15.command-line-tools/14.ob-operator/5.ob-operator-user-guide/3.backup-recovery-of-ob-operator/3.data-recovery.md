# 数据恢复

本文档介绍从备份数据恢复的方法。

## 前提

* 存在成功备份可恢复的数据。

* 集群正常运行，并且剩余资源足够创建恢复租户。

## 数据恢复配置文件说明

### OceanBase 数据库 V3.x 版本的数据恢复

恢复数据配置文件如下：

```yaml
apiVersion: cloud.oceanbase.com/v1
kind: Restore
metadata:
  name: ob-restore
  namespace: obcluster
spec:
  savePoint:
    value: "2023-07-07 15:05:35.536997"
  source:
    clusterName: ob-test
    clusterID: 1
    tenant: tenant1
    path:
      root: file:///ob-backup
  decryptionSecret: backup-secret
  dest:
    clusterName: ob-test
    clusterID: 1
    tenant: ob_restore
    kmsEncryptInfo: ''
    topology:
      - zone: zone1
        unitNum: 1
        type:
          name: FUll
          replica: 1
        priority: 3
        resource:
          maxCPU: 2500m
          minCPU: 2
          memorySize: 1Gi
```

配置说明如下：

* savePoint：数据恢复的位点，value 传要恢复的时间点。
* source: 备份数据，包括集群的信息，租户和备份文件的地址。
* decryptionSecret: 解密备份数据的 secret， 如果备份数据时配置了数据加密，则这里需要配置,  使用相同的 secret 即可。
* dest:  恢复目标, 包括集群的信息和要恢复的租户名，租户的资源配置。
  
### OceanBase 数据库 V4.x 版本数据恢复

恢复数据配置文件如下：

```yaml
apiVersion: cloud.oceanbase.com/v1
kind: Restore
metadata:
  name: ob-restore
  namespace: obcluster
spec:
  savePoint:
    type: time
    value: "2023-07-07 15:05:35.536997"
  source:
    clusterName: ob-test
    clusterID: 1
    tenant: tenant1
    path:
      data: file:///ob-backup/t1/data
      log: file:///ob-backup/t1/log
  decryptionSecret: backup-secret
  dest:
    clusterName: ob-test
    clusterID: 1
    tenant: ob_restore
    kmsEncryptInfo: ''
    topology:
      - zone: zone1
        unitNum: 1
        type:
          name: FUll
          replica: 1
        priority: 3
        resource:
          maxCPU: 2500m
          minCPU: 2
          memorySize: 1Gi
```

配置说明如下:

* savePoint：数据恢复的位点，支持 scn 和 time，value 配置具体的 scn 或者 time。
* source: 备份数据，包括集群的信息，租户和备份文件的地址。
* decryptionSecret: 解密备份数据的 secret， 如果备份数据时配置了数据加密，则这里需要配置,  使用相同的 secret 即可。.
* dest:  恢复目标, 包括集群的信息和要恢复的租户名，租户的资源配置。

## 发起数据恢复

使用以下命令发起数据恢复。

```shell
kubectl apply -f restore.yaml
```

## 查看数据恢复状态

* 使用以下命令查看 Custom Resource 状态。

  ```shell
  kubectl get restore ob-restore -n obcluster -o yaml
  ```

* 查看租户恢复是否成功。

  * 连接 sys 租户。

    ```shell
    mysql -hxxx.xxx.xxx.xxx -P2881 -uroot oceanbase -A -c
    ```

  * 查看需恢复的租户是否恢复。

    ```sql
    select * from DBA_OB_TENANTS;
    ```
