# 副本概述

本节主要介绍副本相关的基础概念及 OceanBase 数据库支持的副本类型。

## 副本基础信息

在介绍副本前，需要了解以下信息：

* Log：本文中主要指与事务相关的 Clog 日志。

* MemTable：表示目前内存中已经被读写更改过的数据，也可称之为内存表。

* SSTable：表示存储在磁盘中的基线数据，当数据被事务读取或修改时，会暂存在 MemTable 中。合并发生时 MemTable 中的数据会和 SSTable 中的数据进行合并形成更新版本的 SSTable。

为了数据安全和提供高可用的数据服务，每个日志流的数据在物理上存储多份，每一份叫做日志流的一个副本。每个副本，包括存储在磁盘上的 Tablet 的静态数据（ SSTable ）、存储在内存上的 Tablet 的增量数据（ MemTable ）以及记录事务的日志三类主要的数据。根据存储数据种类的不同，副本有几种不同的类型，以支持不同业务在在数据安全，性能伸缩性，可用性，成本等之间的选择。

## 副本类型

当前，OceanBase 数据库支持以下几种副本类型：

* 全功能型副本（F）

  目前支持的普通副本，拥有事务日志、MemTable 和 SSTable 等全部完整的数据和功能。它可以随时快速切换为 Leader 以对外提供服务。

* 只读型副本（R）

  只读型副本提供读的能力，不提供写的能力，只能作为日志流的 Follower 副本，不参与选举及日志的投票，不能当选为日志流的 Leader 副本。
  
以下表展示了上述副本的特性差异。

|       特性         |             全功能型         |                     只读型                    |
|-------------------|------------------------------|----------------------------------------------|
| LOG               | 有，参与投票（ SYNC_CLOG ）     | 有，但不属于 Paxos 组，只是 learner（ ASYNC_CLOG ） |
| MemTable          | 有（ WITH_MEMSTORE ）          | 有（ WITH_MEMSTORE ）                       |
| SSTable           | 有（ WITH_SSSTORE ）           | 有（ WITH_SSSTORE ）                        |
| 数据安全           | 高                            | 中                                        |
| 恢复为 Leader 的时间 | 快                          | 不支持                                      |
| 资源成本           | 高                            | 高                                        |
| 服务               | Leader 提供读写， Follower 可非一致性读    | 非一致性读                     |
| 名称（缩写）         | FULL（ F ）                  | READONLY（ R ）                            |
| 副本类型值          | 0                             | 16                                       |

<main id="notice" type='explain'>
<h4>说明</h4>
<p>副本类型值是副本类型名称对应的 ID，内部代码是通过此 ID 来识别不同的副本类型。<code>replica_type</code> 字段如果是 varchar，则会显示副本类型名称；如果是 int，会显示副本类型值。</p>
</main>

## 广播日志流

日志流是由 OceanBase 数据库自动创建和管理的实体，它代表了一批数据的集合，包括若干数据分区，及对其进行事务操作的日志和事务管理结构。

日志流是 OceanBase 数据库在 V4.0.0 版本新引入的概念，OceanBase 数据库 V4.x 相比于 OceanBase 数据库 V3.x 最大的改变就是改变了事务提交的基本单位，从而在资源、性能、功能三个方面带来了很大价值。

* 在 OceanBase 数据库 V3.x 中，OceanBase 数据库以分区为单位进行事务提交，分区内的修改由分区内 WAL 保证修改的原子性，每个分区作为两阶段提交的参与者，事务提交的基本单位是分区。
* 在 OceanBase 数据库 V4.x 中，OceanBase 数据库以日志流为单位进行事务提交，日志流内的修改由日志流内 WAL 保证修改的原子性，每个日志流作为两阶段提交的参与者，事务提交的基本单位是日志流。

上述日志流也称为普通日志流，从 V4.2.0 版本开始，OceanBase 数据库又新引入了广播日志流的概念。当某个租户的第一个复制表被创建时，同时系统会创建一个特殊的日志流，称为广播日志流。之后新建的复制表都会创建到这个广播日志流上。广播日志流与普通日志流的不同之处在于，广播日志流会自动地在租户内的每个 OBServer 节点上均部署一个副本，保证在理想情况下复制表可以在任意一个 OBServer 节点上提供强一致性读。

一般来说，参与一致性协议投票的副本过多，就会导致达成多数派需要的时间越长。在一个租户内的 OBServer 节点较多时，自然不可能让所有的 OBServer 上的副本都参与投票。因此，广播日志流就会在不需要参与投票的 OBServer 上会部署 R 副本（READONLY 副本，只读型副本），在需要参与投票的 OBServer 节点上部署常规的 F 副本（FULL 副本，即全功能型副本）。

广播日志流与普通日志流对副本的差异如下：

* 对于普通日志流来说，每个 Zone 仅能有一个副本，且该副本类型需要与 Locality 中指定的副本类型匹配。
* 对于广播日志流来说，每个 Zone 内，除了 Locality 中描述的该 zone 的副本类型外，在该 Zone 内其余有该租户 Unit 资源的机器上还会各放置一个只读型副本。对 Locality 中没有指定副本类型的 Zone 不放置任何副本。

广播日志流的使用限制如下：

* `sys` 租户、所有 `Meta` 租户均没有广播日志流，不支持复制表创建。
* 每个用户租户最多只能有一个广播日志流。
* 不支持广播日志流和普通日志流之间的属性转换。
* 不支持手动删除广播日志流，当前仅支持广播日志流随着租户的删除而删除。

## 更多信息

关于复制表的介绍及使用，请参见 [创建表（MySQL 模式）](../../3.database-object-management/1.manage-object-of-mysql-mode/2.manage-tables-of-mysql-mode/2.create-a-table-for-mysql-tenant-of-mysql-mode.md) 和 [创建表（Oracle 模式）](../../3.database-object-management/2.manage-object-of-oracle-mode/1.manage-tables-of-oracle-mode/2.create-a-table-for-oracle-tenant-of-oracle-mode.md) 。
