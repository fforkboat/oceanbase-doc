# 存储过程的 SQL 信息收集

OceanBase 数据库在编译期间会收集存储过程中是否涉及 DML 语句/读写 Package 变量等因子，这些信息主要用于嵌套场景下，判断带 UDF（User-Defined functions）或者 Trigger 的 DML 语句是否要并行执行。

## 原理介绍

存储过程对 SQL 语句的分析逻辑如下：

1. 分析存储过程内部是否有读写 SQL 语句（包括 DML/DDL/TCL 语句），以及 `CURSOR` 语句、`FORALL` 语句、动态 SQL 和 `DBMS_SQL` 系统包相关接口的信息。
2. 分析存储过程内部有 Package 变量。
3. 分析存储过程内部是否有 Sequence。
4. 存储过程 `a` 内部有访问存储过程 `b` 的情况:
   1. 存储过程 `b` 为 Procedure：Inner Call 场景，依据 `b` 的分析信息，决定存储过程 `a`，即如果 `b` 不能并行，那么 `a` 也不能并行。
   2. 存储过程 `b` 为 Function：UDF 可以出现在存储过程内大部分语句中。
   3. 存储过程内部 SQL 关联了 Trigger，该步骤可以省略，因为 SQL 语句本身当作了并行影响因子。

由此，下述表格中的变量需要维护并记录到 `obroutineinfo` 或者 `triggerinfo` 上落盘。

| 变量名称       |                        含义                                      |
|---------------|------------------------------------------------------------------|
| no_sql        | 表示存储过程没有 SQL 语句。    |
| read_sql      | 表示存储过程有读 SQL。         |
| write_sql     | 表示存储过程有写 SQL。         |
| contain_sql   | 表示存储过程包含 SQL 语句，但是不包含读写 SQL。|
| wnps_flag     | 表示没有写 Package 变量。|
| rnps_flag     | 表示没有读 Package 变量。|
| has_seq       | 表示包含 Sequence 和 `resolve_sequence_object`。|
| has_out_param | 表示包含出参。|
| external_state| 表示存在访问外部状态的情况，例如其他存储过程，后续查找依赖对象 Schema。|


当 SQL 查询和 DML 语句触发 UDF/Trigger 时，根据如下步骤基于分析信息考虑 UDF/Trigger 的并行执行问题：

1.获取 `obroutineinfo` 和 `triggerinfo` 信息，查看是否存在并行执行影响因子，如果存在则串行执行。否则根据 `external_state` 决定是否执行第二步。
2.获取存储过程依赖的其他存储过程，递归判断是否有并行执行影响因子。

如果 UDF 或者 Trigger 存在上述情况，则强制走 DAS 和串行执行，并且禁止 DML 语句做 Batch 操作；否则，允许并行执行。

## 相关限制

当 Subprogram（子过程）具有下述行为时，被认为是有副作用的:

* Subprogram 有出参。
* Subprogram 修改了 Pacakge 变量。
* Subprogram 修改了全局变量。
* Subprogram 修改了数据库或者表。
* Subprogram 修改了其他外部状态。

由于上述副作用的存在，触发 UDF 的并行查询将会被阻止，并改为串行执行。

对于 SQL 语句触发的 UDF（Trigger），存在下述限制：

* 外层 SQL 语句为查询或者 DML 语句时，UDF 不能结束事务，创建或回滚 Savepoint 或者执行 `ALTER SYSTEM`/`ALTER SESSION`。
* 外层 SQL 为查询或者 PDML 语句时，UDF 内部不能有 DML 语句，或其他修改数据库的语句（PDML 场景未报错）。
* 外层 SQL 为 DML 语句时，UDF 内部不能读写相同的表。

无论是从 PL 调用，或者直接嵌入到函数体中，或者使用 `EXECUTE IMMEDIATE` 语句运行，或者使用 `DBMS_SQL` 包运行，上述限制均适用。

